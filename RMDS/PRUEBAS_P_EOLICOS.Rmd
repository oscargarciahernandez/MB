---
title: "PRUEBA PARQUES EÓLICOS"
author: "Oscar Garcia Hernandez"
date: "8/7/2019"
output:
  html_document:
      code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      cache = TRUE)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggplot2)
library(ggplot2)
library(RNetCDF)
library(stringr)
library(lubridate)
library(request)
library(XML)
library(dplyr)
library(TTR)
library(data.table)
library(GGally)
library(e1071)
library(geosphere)
library(maptools)
library(gdata)
library(knitr)
library(OpenStreetMap)
library(ggplot2)
library(here)
library(magrittr)
library(dplyr)
library(RColorBrewer)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
source(here::here('libraries.R'))

```

### INTRODUCCIÓN

<br />
<br />

Esto es un informe del desarrollo y detalles preliminares de las pruebas que vamos a realizar para el forecast de la produccion de 4 parques eólicos distribuidos. 
<br />
<br />


### INFORMACION DE LOS PARQUES

A continuación se presentan la informacion referente a los parques eólicos. 

<br />
<br />

```{r}
DATA_PARQUES<- read.csv(here::here('Data/Parques/PRUEBA_EOLICOS/windfarm/INFO_PARQUES.csv'))
kable(DATA_PARQUES)
```

<br />
<br />

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) +
  geom_sf()+
  geom_point(data= DATA_PARQUES, aes(x= Longitude, y= Latitude), color= "red")+
  theme_light()

```
<br />
<br />

```{r}
TABLA_PARQUES<- readRDS(here::here('Data/Parques/PRUEBA_EOLICOS/Historico_PE.RDS')) %>% bind_rows()
colnames(TABLA_PARQUES)<- c('PARQUE', 'DATE', 'PRUDUCCION_MWH', 'DISPONIBILIDAD', 'POTENCIA_INSTALADA', 'UNIDADES DE TURBINAS','LON', 'LAT' )
kable(head(TABLA_PARQUES))

rango_tiempo<- TABLA_PARQUES %>% group_split(PARQUE) %>% lapply(function(x) return((paste(x$PARQUE %>% unique(),":",paste(x$DATE %>% range, collapse = " ----> ")))))
rango<- rango_tiempo %>% unlist() %>% matrix(ncol = 1) %>% as.data.frame()
colnames(rango)<- 'RANGO DE TIEMPO DE LOS DATOS'
kable(rango)






```


Vemos que tenemos 1 año y medio de histórico para los Parques de Cerroblanco, Waubra y Tatanka. Y un año de histórico para el parque de Tamaulipas. 
Tenemos datos de Producción horaria y Disponibilidad, para cada hora. 

<br />

Esto nos vale para saber el periodo en el que debemos construir el historico, localizaciones y demás. Ahora nos pasamos a trabajar en la construccion de estos históricos, para ello, nos disponemos a descargar los GFS's (archivos de inicializacion del modelo WRF) que nos falter para realizar el histórico para cada parque. De este modo podremos comprobar como se comporta el nuestro modelo. Y que nivel de precisión. 


### AUTOMATIZAR WRF PARA CREAR HISTÓRICO DE LOS PARQUES

El script de python para automatizar el proceso ya está creado. 

<br />
<br />


### CERRO BLANCO

<br />
Pasamos a hacer un análisis preliminar de los datos de CERROBLANCO, debido a que contamos con esos datos. 

<br />
Dentro de los datos con los que contamos tenemos datos de Disponibilidad (%), Producción en MWH y tambien datos de los tipos de aerogeneradores y de la potencia máxima de cada parque 

<br />
<br />

```{r}
INFO_PE<-  here::here('Data/Parques/PRUEBA_EOLICOS/Historico_PE.RDS') %>% readRDS()
INFO_CB<- INFO_PE %>% filter(PARQUE=='P.E. Cerroblanco')

kable(head(INFO_CB))


```

<br />


**El parque de cerroblanco cuenta con una potencia máxima instalada de 48 MW.**

<br />
 

```{r}
kable(summary(INFO_CB[, c("PRUDUCCION_MWH","DISPONIBILIDAD")]))
```

<br />
<br />


### CREAMOS VARIABLE DE FACTOR DE CAPACIDAD

<br />
<br />

Voy a crear una variable que sea *(DISPONIBILIDAD X POTENCIA_TOTAL)*, suponiendo que la disponibilidad es el porcentaje del parque eólico que está preparado para producir. Esta variable la podremos llamar CAPACIDAD_REAL.  
De esta manera podremos sacar un Factor de Capacidad del parque Real para cada hora. Lo que haremos será multiplicar ese valor de (CAPACIDAD REAL * 1 h ) y dividiremos la ENERGIA Real (PRODUCCIÓN), entre esta variable, que podemos llamar, ENERGÍA MÁXIMA EXTRAIBLE.

<br />
<br />

POR LO TANTO, **EL FACTOR DE CAPACIDAD REPRESENTA ALGO ASÍ COMO: EL PORCENTAJE DE ENERGÍA QUE HA EXTRAÍDO DURANTE ESA HORA...** 


Sabiendo este valor de factor de capacidad horario podemos intuir, o directamente calcular el valor del la velocidad media del viento durante esta hora. Si tuvieramos la curva de potencia del aerogenerador, (cosa que me temo que tendremos que sacar nosotros por nuestra cuenta) sería un cálculo, a mi parecer, muy lógico. 

<br />
<br />

```{r}
INFO_CB<- INFO_CB %>% mutate(CAPACIDAD_REAL= (DISPONIBILIDAD*CAPACIDAD/100),
                             FC= (PRUDUCCION_MWH/CAPACIDAD_REAL))

ggplot(INFO_CB)+
  geom_line(aes(x=DATE, y=DISPONIBILIDAD))+
  geom_line(aes(x=DATE, y=FC * 100), col= "red" , alpha= 0.3)+
  geom_line(aes(x=DATE, y=PRUDUCCION_MWH), col= "blue" , alpha= 0.4)+
  theme_light()+
  labs(title = 'Disponibilidad[%](negra), FC[%](roja) y Producción[MWH](azul)')
  

```

En la gráfica en la que no eliminamos el ruido nos encontramos con varios valores de factor de capacidad infinito... Hay que tener en cuenta para eliminarlos posteriormente. 


<br />
<br />

```{r}

#ELIMINAMOS LOS INFINITOS
 INFO_CB$FC<- ifelse(is.infinite(INFO_CB$FC), 0, INFO_CB$FC)
 ggplot(INFO_CB)+
  geom_line(aes(x=DATE, y=DISPONIBILIDAD))+
  geom_line(aes(x=DATE, y=FC * 100), col= "red" , alpha= 0.3)+
  geom_line(aes(x=DATE, y=PRUDUCCION_MWH), col= "blue" , alpha= 0.4)+
  theme_light()+
  labs(title = 'Disponibilidad[%](negra), FC[%](roja) y Producción[MWH](azul)')
  
 


MA<- INFO_CB %>% .[complete.cases(.), ]
MA<- MA[!is.infinite(MA$FC),]
MA$DISP<- SMA(MA$DISPONIBILIDAD, 48)
MA$FC<- SMA((MA$FC * 100), 96)
MA$PROD<- SMA(MA$PRUDUCCION_MWH, 96)

ggplot(MA)+
  geom_line(aes(x=DATE, y=DISPONIBILIDAD), alpha= 0.4)+
  geom_line(aes(x=DATE, y=FC), col= "red")+
  geom_line(aes(x=DATE, y= PROD), col= "blue")+
  theme_light()+
  labs(title = 'Disponibilidad[%](negra), FC[%](roja) y Producción[MWH](azul)',
       subtitle = 'Aplicando MA para suavizar la gráfica')

```

<br />
<br />



### IMPORTAMOS DATOS HISTÓRICOS DE WRF Y JUNTAMOS

Lo dicho reciclamos nuestro histórico y pillamos los datos de velocidad del viento, para el punto del WRF más cercano. SI QUEREMOS CAMBIAR EL PUNTO O PILLAR MÁS VARIABLES, HABRÁ QUE MODIFICAR CERROBLANCO.R Y CREAR UN NUEVO HISTÓRICO. 


<br />
<br />

```{r}

HIST_WRF<-  here::here('Data/Parques/CERROBLANCO/Historico/TABLA_WIND_CERROBLANCO_AFINADA.RDS') %>% readRDS()
colnames(HIST_WRF)<- HIST_WRF %>% colnames() %>% toupper()
HIST_WRF[,c("LON_WRF", "LAT_WRF")]<-HIST_WRF[,c("LON", "LAT")] 
HIST_WRF[,c("LON","LAT")]<- NULL

# JUNTAMOS LOS DATOS 
TABLA_MERGE<- left_join(INFO_CB, HIST_WRF, by= "DATE")



###NOS QUEDAMOS SOLO CON LOS DATOS COMPLETOS
TABLA_MERGE <- TABLA_MERGE %>% .[complete.cases(.), ] 


###VEMOS COMO AUNQUE HEMOS ELIMINADO MUCHAS FILAS FALTANTES 
###EXISTEN GRANDES PERIODOS DE TIEMPO CON HUECOS
ggplot(data = TABLA_MERGE)+
  geom_point(aes(y= PRUDUCCION_MWH, x=DATE))+
  geom_point(aes(y= WS, x=DATE), col="red")+ 
  ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS PRODUCCION MWH')+
  theme_light()
```

<br />
<br />


Vemos que faltan un mogollón de datos en el periodo de 2018, por ello, vamos a recortarlos para quedarnos únicamente con el periodo de continuidad. 




<br />
<br />

A continuación se presentan una serie de gráficas solmente del mes de Diciembre de 2018, simplemente para hacer un análisis preliminar... 

<br />


```{r}

TABLA_MERGE_DEC<- TABLA_MERGE %>% filter(month(DATE)== 12)
ggplot(data = TABLA_MERGE_DEC)+
  geom_point(aes(y= PRUDUCCION_MWH, x=DATE), alpha= 0.2)+
  geom_point(aes(y= WS, x=DATE), col="red", alpha= 0.2)+
    geom_line(aes(y= PRUDUCCION_MWH, x=DATE), alpha= 0.5)+
  geom_line(aes(y= WS, x=DATE), col="red", alpha= 0.5)+
   ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS PRODUCCION MWH')+
  labs(subtitle = 'VARIABLES SIN NORMALIZAR')+
  theme_light()
```


<br />
<br />


Tiene mucha mejor pinta, verdad??¡ incluso me atrevería a decir que tienen buena correlación. Pero antes de eso, que no se nos olvide que estamos tratando dos variables con unidades diferentes, vamos a normalizar las curvas. 


<br />
<br />

```{r}
max_p<- max(TABLA_MERGE_DEC$PRUDUCCION_MWH)
min_p<- min(TABLA_MERGE_DEC$PRUDUCCION_MWH)

max_v<- max(TABLA_MERGE_DEC$WS)
min_v<- min(TABLA_MERGE_DEC$WS)

TABLA_MERGE_DEC<- TABLA_MERGE_DEC %>% mutate(PRODUCC_NORM= (PRUDUCCION_MWH-min_p)/(max_p-min_p),
                                     WS_NORM= (WS-min_v)/(max_v-min_v) )
ggplot(data = TABLA_MERGE_DEC)+
    geom_line(aes(y= PRODUCC_NORM, x=DATE), alpha= 0.5)+
  geom_line(aes(y= WS_NORM, x=DATE), col="red", alpha= 0.5)+
   ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS PRODUCCION MWH')+
  labs(subtitle = 'VARIABLES NORMALIZADAS')+
  theme_light()
```


<br />
<br />


```{r}
x<- cor(TABLA_MERGE_DEC$PRODUCC_NORM, TABLA_MERGE_DEC$WS_NORM)
print(paste('Correlacion de: ', x))
```

<br />
<br />


```{r}
ggplot(data = TABLA_MERGE_DEC)+
    geom_line(aes(y= FC, x=DATE), alpha= 0.5, col= 'blue')+
  geom_line(aes(y= WS_NORM, x=DATE), col="red", alpha= 0.5)+
   ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS FACTOR DE PLANTA')+
  theme_light()
```


<br />
<br />


```{r}
TABLA_MERGE_DEC<- TABLA_MERGE_DEC[complete.cases(TABLA_MERGE_DEC), ] 
x<- cor(TABLA_MERGE_DEC$FC, TABLA_MERGE_DEC$WS_NORM, use = "all.obs")

print(paste('Correlacion de: ', x))

```

<br />
<br />



```{r}
ggplot(data = TABLA_MERGE_DEC)+
    geom_line(aes(y= FC, x=DATE), alpha= 0.5, col= 'blue')+
  geom_line(aes(y= PRODUCC_NORM, x=DATE), col="green", alpha= 0.5)+
   ggtitle('FACTOR DE PLANTA (AZUL) VS PRODUCCION_NORMALIZADA (VERDE)')+
  theme_light()
```

<br />
<br />



ME PARECE MUY CURIOSO Y DESCONCERTANTE QUE EL FACTOR DE CAPACIDAD Y LA PRODUCCIÓN NORMALIZADA SE PAREEZCAN TANTO.... LO SUYO ES QUE DIFIERAN... NO?? 


<br />
<br />

```{r}
TABLA_CORR<- TABLA_MERGE %>% group_split(month(DATE), year(DATE)) %>% lapply(function(x){
  tabla_cor<- data.frame(year(x$DATE) %>% unique(),
                         month(x$DATE) %>% unique(), 
                         cor(x$FC, x$WS),
                         cor(x$FC, x$WSMAX),
                         cor(x$PRUDUCCION_MWH, x$WS),
                         cor(x$PRUDUCCION_MWH, x$WSMAX),
                         nrow(x))
  colnames(tabla_cor)<- c("year", "mont", "FC_cor",
                           "FC_corMAX", "PRODUC_cor", 
                          "PRODUC_corMAX", "cases")
  return(tabla_cor)
  
  }) %>% bind_rows() 

TABLA_CORR %>% kable()


TABLA_CORR[,3:ncol(TABLA_CORR)] %>% summarise_all(mean) %>%  kable()
```


Filtramos la tabla y eliminamos los meses que contengan menos de  400 casos. 
```{r}
TABLA_CORR_FILT<- TABLA_CORR %>% filter(cases > 400 )
TABLA_CORR_FILT %>% kable()

TABLA_CORR_FILT[,3:ncol(TABLA_CORR)] %>% summarise_all(mean) %>%  kable()

```


A continuacion realizamos lo mismo pero añadiendo un filtrado tambien semanal. El objetivo es obtener la semana con mejor y la semana con peor correlación y después hacer un anáñisis mas exhaustivo de esas semanas. 

```{r}
TABLA_CORR<- TABLA_MERGE %>% group_split(month(DATE), year(DATE), week(DATE)) %>% lapply(function(x){
  tabla_cor<- data.frame(year(x$DATE) %>% unique(),
                         month(x$DATE) %>% unique(), 
                         week(x$DATE) %>% unique(),
                         cor(x$FC, x$WS),
                         cor(x$FC, x$WSMAX),
                         cor(x$PRUDUCCION_MWH, x$WS),
                         cor(x$PRUDUCCION_MWH, x$WSMAX),
                         nrow(x))
  colnames(tabla_cor)<- c("year", "mont","week", "FC_cor",
                           "FC_corMAX", "PRODUC_cor", 
                          "PRODUC_corMAX", "cases")
  return(tabla_cor)
  
  }) %>% bind_rows() 

TABLA_CORR %>% kable()


TABLA_CORR[,3:ncol(TABLA_CORR)] %>%  .[complete.cases(.),] %>% summarise_all(mean) %>%  kable()
```



```{r}

TABLA_CORR_FILT<- TABLA_CORR %>% .[complete.cases(.),] %>% filter(cases > 130 )
TABLA_CORR_FILT %>% kable()

TABLA_CORR_FILT[,3:ncol(TABLA_CORR)] %>% summarise_all(mean) %>%  kable()
```

```{r}
max_cor<- TABLA_CORR_FILT[(TABLA_CORR_FILT[,c("FC_cor")] %>% which.max()),]
max_cor %>% kable()
min_cor<-TABLA_CORR_FILT[(TABLA_CORR_FILT[,c("FC_cor")] %>% which.min()),]
min_cor %>% kable()
```


```{r}
TABLA_MAX_WEEK<- TABLA_MERGE %>% filter(year(DATE)==max_cor$year,
                       month(DATE)==max_cor$mont,
                       week(DATE)==max_cor$week)

TABLA_MIN_WEEK<- TABLA_MERGE %>% filter(year(DATE)==min_cor$year,
                       month(DATE)==min_cor$mont,
                       week(DATE)==min_cor$week)
```


## ANÁLISIS DE LA SEMANA CON PEOR CORRELACION

```{r}
ggplot(TABLA_MIN_WEEK)+
  geom_line(aes(x=DATE, y=DISPONIBILIDAD))+
  geom_line(aes(x=DATE, y=FC * 100), col= "red" , alpha= 0.3)+
  geom_line(aes(x=DATE, y=PRUDUCCION_MWH), col= "blue" , alpha= 0.4)+
  theme_light()+
  labs(title = 'Disponibilidad[%](negra), FC[%](roja) y Producción[MWH](azul)')
  

```
```{r}
max_p<- max(TABLA_MIN_WEEK$PRUDUCCION_MWH)
min_p<- min(TABLA_MIN_WEEK$PRUDUCCION_MWH)

max_v<- max(TABLA_MIN_WEEK$WS)
min_v<- min(TABLA_MIN_WEEK$WS)

TABLA_MIN_WEEK<- TABLA_MIN_WEEK %>% mutate(PRODUCC_NORM= (PRUDUCCION_MWH-min_p)/(max_p-min_p),
                                     WS_NORM= (WS-min_v)/(max_v-min_v) )
ggplot(data = TABLA_MIN_WEEK)+
    geom_line(aes(y= PRODUCC_NORM, x=DATE), alpha= 0.5)+
  geom_line(aes(y= WS_NORM, x=DATE), col="red", alpha= 0.5)+
   ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS PRODUCCION MWH')+
  labs(subtitle = 'VARIABLES NORMALIZADAS')+
  theme_light()
```
```{r}
ggplot(data = TABLA_MIN_WEEK)+
    geom_line(aes(y= FC, x=DATE), alpha= 0.5, col= 'blue')+
  geom_line(aes(y= WS_NORM, x=DATE), col="red", alpha= 0.5)+
   ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS FACTOR DE PLANTA')+
  theme_light()
```

Analizamos la influencia de las demás variables.

```{r}
ggplot(TABLA_MIN_WEEK)+
  geom_line(aes(x=DATE, y=T02_MIN-273), col= "orange", alpha= 0.5)+
  geom_line(aes(x=DATE, y=T02_MEAN-273), col= "orange")+
  geom_line(aes(x=DATE, y=T02_MAX-273), col= "orange", alpha= 0.7)+

  geom_line(aes(x=DATE, y=WS), col= "red" , alpha= 0.9)+
  geom_line(aes(x=DATE, y=WSMAX), col= "red" , alpha= 0.6)+
  geom_line(aes(x=DATE, y=G10_MAX), col= "purple", alpha= 0.9)+
  geom_line(aes(x=DATE, y=GUST10M), col= "purple", alpha= 0.6)+



  geom_line(aes(x=DATE, y=DISPONIBILIDAD*0.2))+
  theme_light()+
  labs(title = 'TEMPERATURA(naranja), GUST(violeta), Wind(red), Produccion(NEGRO)')
  
```



## ANÁLISIS DE LA SEMANA CON MEJOR CORRELACION

```{r}
ggplot(TABLA_MAX_WEEK)+
  geom_line(aes(x=DATE, y=DISPONIBILIDAD))+
  geom_line(aes(x=DATE, y=FC * 100), col= "red" , alpha= 0.3)+
  geom_line(aes(x=DATE, y=PRUDUCCION_MWH), col= "blue" , alpha= 0.4)+
  theme_light()+
  labs(title = 'Disponibilidad[%](negra), FC[%](roja) y Producción[MWH](azul)')
  

```
```{r}
max_p<- max(TABLA_MAX_WEEK$PRUDUCCION_MWH)
min_p<- min(TABLA_MAX_WEEK$PRUDUCCION_MWH)

max_v<- max(TABLA_MAX_WEEK$WS)
min_v<- min(TABLA_MAX_WEEK$WS)

TABLA_MAX_WEEK<- TABLA_MAX_WEEK %>% mutate(PRODUCC_NORM= (PRUDUCCION_MWH-min_p)/(max_p-min_p),
                                     WS_NORM= (WS-min_v)/(max_v-min_v) )
ggplot(data = TABLA_MAX_WEEK)+
    geom_line(aes(y= PRODUCC_NORM, x=DATE), alpha= 0.5)+
  geom_line(aes(y= WS_NORM, x=DATE), col="red", alpha= 0.5)+
   ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS PRODUCCION MWH')+
  labs(subtitle = 'VARIABLES NORMALIZADAS')+
  theme_light()
```
```{r}
ggplot(data = TABLA_MAX_WEEK)+
    geom_line(aes(y= FC, x=DATE), alpha= 0.5, col= 'blue')+
  geom_line(aes(y= WS_NORM, x=DATE), col="red", alpha= 0.5)+
   ggtitle('VELOCIDAD DEL VIENTO (ROJO) VS FACTOR DE PLANTA')+
  theme_light()
```

```{r}
ggplot(TABLA_MAX_WEEK)+
  geom_line(aes(x=DATE, y=T02_MIN-273), col= "orange", alpha= 0.5)+
  geom_line(aes(x=DATE, y=T02_MEAN-273), col= "orange")+
  geom_line(aes(x=DATE, y=T02_MAX-273), col= "orange", alpha= 0.7)+

  geom_line(aes(x=DATE, y=WS), col= "red" , alpha= 0.9)+
  geom_line(aes(x=DATE, y=WSMAX), col= "red" , alpha= 0.6)+
  geom_line(aes(x=DATE, y=G10_MAX), col= "purple", alpha= 0.9)+
  geom_line(aes(x=DATE, y=GUST10M), col= "purple", alpha= 0.6)+



  geom_line(aes(x=DATE, y=DISPONIBILIDAD*0.3))+
  theme_light()+
  labs(title = 'TEMPERATURA(naranja), GUST(violeta), Wind(red), Produccion(NEGRO)')
```


### LOCALIZACION CERROBLANCO 

<br />
<br />

```{r}
include_graphics(here::here('RMDS/imagenes/cerroblanco0.png'))
```

```{r}
include_graphics(here::here('RMDS/imagenes/cerroblanco1.png'))
```

```{r}
include_graphics(here::here('RMDS/imagenes/cerroblanco2.png'))
```

```{r fig.height = 10, fig.width = 10, fig.align = "center"}
library(rasterVis)

raster_files<- here::here('Mapas/Raster_Cerroblanco/') %>% list.files(full.names = T)

for (i in 1:length(raster_files)) {
  
  map_raster<- raster_files[i] %>% readRDS()
  print(  levelplot(map_raster) + 
  layer(panel.points(TABLA_MERGE$LON %>% unique(),
                     TABLA_MERGE$LAT %>% unique(), pch=21, cex=1, colour='white', fill= 'white')))
  
}

```

