---
title: "Predictive model for Belesar dam"
author: "Eduardo Roman y Óscar García"
date: "17/4/2019"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections:  true
    df_print: paged
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      cache = TRUE,
                      warning = FALSE, 
                      fig.align = "center")
library(ggplot2)
library(RNetCDF)
library(stringr)
library(lubridate)
library(request)
library(XML)
library(dplyr)
library(TTR)
library(data.table)
library(GGally)
library(e1071)
library(geosphere)
library(imputeTS)
```


# Indroduction

<br />
<br />

In this document the progress achived in the development of the predictive model for the streamflow of Belesar Dam during the last weeks will be explained. 

<br />
<br />
For this purpose we count with a historical data from january of 2018 to februrary of 2019. It should be note that **the quality of the data was medium-low, with very noisy data and also a lot of outliers, such as, negative values in the streamflow dataset**.   


<br />
<br />

For the elaboration of this predicctive model we will use ARW-WRF model rain output. **It's remarkable that we are getting very good correlations between WRF model data and the historical data**.  Maybe the best noticce is that the best correlation is for the long-term cumulative rain results. This resutls are shown next in figures in this document. 

<br />
<br />

All the procces is being carried out using several machine learning tools. **The first predictive models that we have elaborate are being developed using common regression techniques, these first models are getting good performance, but only for the next 3 days. For getting a good long-term prediction, more sofisticated methods should be implemented**. 

<br />
<br />

Nowadays, we are calculating the best predictive model for achieved a good performance for a long-term prediction. For getting the best model using this tool we are using **cross-validation techniques for more that 45 algorithms**. After the best algorithms are being selected, another procces for adjusting the parameters will be carried out, this requires high computational cost and also time. 

<br />
<br />
```{r cols.print= 5, rows.print=3, include=FALSE}
DHI<- readRDS(here::here('Data/Parques/Belesar/Historico/Historico_DHI_Belesar.RDS'))

outlierKD <- function(dt, var) {
  var_name <- eval(substitute(var),eval(dt))
  tot <- sum(!is.na(var_name))
  na1 <- sum(is.na(var_name))
  m1 <- mean(var_name, na.rm = T)
  par(mar = rep(2, 4))
  par(mfrow=c(2, 2), oma=c(0,0,3,0))
  boxplot(var_name, main="With outliers")
  hist(var_name, main="With outliers", xlab=NA, ylab=NA)
  outlier <- boxplot.stats(var_name)$out
  mo <- mean(outlier)
  var_name <- ifelse(var_name %in% outlier, NA, var_name)
  boxplot(var_name, main="Without outliers")
  hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
  title("Outlier Check", outer=TRUE)
  na2 <- sum(is.na(var_name))
  message("Outliers identified: ", na2 - na1, " from ", tot, " observations")
  message("Proportion (%) of outliers: ", (na2 - na1) / tot*100)
  message("Mean of the outliers: ", mo)
  m2 <- mean(var_name, na.rm = T)
  message("Mean without removing outliers: ", m1)
  message("Mean if we remove outliers: ", m2)
  
    dt[as.character(substitute(var))] <- invisible(var_name)
    assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
    message("Outliers successfully removed", "\n")
    return(invisible(dt))
   
}

DHI$`APORTACION (m3/s)`[which(DHI$`APORTACION (m3/s)`<0)]<- NA 

outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)
outlierKD(DHI,`APORTACION (m3/s)`)


library(imputeTS)

#Rellenamos Huecos
DHI$`APORTACION (m3/s)`<-  na.interpolation(DHI$`APORTACION (m3/s)`)



library(TTR)

outlierKD(DHI,`NIVEL EMBALSE (msnm)`)
DHI$`NIVEL EMBALSE (msnm)`<-  na.interpolation(DHI$`NIVEL EMBALSE (msnm)`)

x<- 96
aportacion_SMA<- SMA(DHI$`APORTACION (m3/s)`,x)
nivel_SMA<- SMA(c(0,diff(DHI$`NIVEL EMBALSE (msnm)`)*8000+150), x)

aportacion_SMA<- aportacion_SMA[!is.na(aportacion_SMA)]
nivel_SMA<- nivel_SMA[!is.na(nivel_SMA)]



ccf_belesar<- ccf(aportacion_SMA, nivel_SMA, lag.max = 5000)
DHI$`LLUVIA ACUMULADA DÍA (l/m2)`<- lead(DHI$`LLUVIA ACUMULADA DÍA (l/m2)`)

Desacumular_lluvia_2018<- DHI[which(year(DHI$DATE)==2018),] %>% group_by(yday(DATE)) %>% mutate(desacumulada= c(diff(`LLUVIA ACUMULADA DÍA (l/m2)`),0),
                                                                         lluvia=ifelse(desacumulada>=0, desacumulada, 0))


Desacumular_lluvia_2019<- DHI[which(year(DHI$DATE)==2019),] %>% group_by(yday(DATE)) %>% mutate(desacumulada= c(diff(`LLUVIA ACUMULADA DÍA (l/m2)`),0),
                                                                              lluvia=ifelse(desacumulada>=0, desacumulada, 0))
Desacumular_lluvia<- rbind(Desacumular_lluvia_2018, Desacumular_lluvia_2019)


Medias_horarias_2018<- as.data.frame(Desacumular_lluvia[year(Desacumular_lluvia$DATE)==2018,]) %>% group_by(yday(DATE), hour(DATE))  %>% 
  summarize(., Acum_horaria=sum(lluvia, na.rm = T),
            aport_mean=mean(`APORTACION (m3/s)`, na.rm = T),
            nivel_mean=mean(`NIVEL EMBALSE (msnm)`, na.rm = T))

Medias_horarias_2019<- as.data.frame(Desacumular_lluvia[year(Desacumular_lluvia$DATE)==2019,]) %>% group_by(yday(DATE),hour(DATE))  %>% 
  summarize(., Acum_horaria=sum(lluvia, na.rm = T),
            aport_mean=mean(`APORTACION (m3/s)`, na.rm = T),
            nivel_mean=mean(`NIVEL EMBALSE (msnm)`, na.rm = T))

Medias_horarias<- rbind(Medias_horarias_2018, Medias_horarias_2019)
vector_Date<- seq(range(DHI$DATE)[1],range(DHI$DATE)[2],
                  by="hour")

Lluvia_acum_horaria<- as.data.frame(cbind(as.character(vector_Date[2:length(vector_Date)]), 
                                          Medias_horarias[,3:5]))



Lluvia_acum_horaria$`as.character(vector_Date[2:length(vector_Date)])`<- ymd_hms(Lluvia_acum_horaria$`as.character(vector_Date[2:length(vector_Date)])`)


colnames(Lluvia_acum_horaria)<- c("Date", "Lluvia_mm", "aport_mean", "nivel_mean")


x<- 96
aportacion_SMA<- SMA(DHI$`APORTACION (m3/s)`,x)
nivel_SMA<- SMA(DHI$`NIVEL EMBALSE (msnm)`, x)

aportacion_horaria<- aportacion_SMA[DHI$DATE%in%vector_Date]
nivel_horario<- nivel_SMA[DHI$DATE%in%vector_Date]

#Se ponen 24 horas para que equivalgan a 1 día 
y<- 24
aportacion_mean_SMA<- SMA(Lluvia_acum_horaria$aport_mean,y)
nivel_mean_SMA<- SMA(Lluvia_acum_horaria$nivel_mean,y)





Tabla_DHI<- as.data.frame(cbind(Lluvia_acum_horaria, 
                                aportacion_horaria[2:length(aportacion_horaria)],
                                nivel_horario[2:length(nivel_horario)], 
                                aportacion_mean_SMA,
                                nivel_mean_SMA))



colnames(Tabla_DHI)<- c(names(Lluvia_acum_horaria), "aport_SMA", "nivel_SMA", 
                        "aport_mean_SMA",  "nivel_mean_SMA")

Tabla_DHI<- Tabla_DHI[complete.cases(Tabla_DHI),]



 k<- max(Tabla_DHI$nivel_mean_SMA)/max(Tabla_DHI$aport_mean_SMA)
 
  ggplot(data=Tabla_DHI, aes(x=Date))+
    geom_line(aes(y=aport_mean_SMA))+
    xlab("Date")+ylab("Aportación [m³/s]")+
    theme(panel.background = element_blank(),
          panel.grid = element_blank())+
    geom_line(aes(y=nivel_mean_SMA/k),group=1, color="red") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k), name = "Nivel [msnm]", 
                                           breaks = seq(min(Tabla_DHI$nivel_mean_SMA),
                                                        max(Tabla_DHI$nivel_mean_SMA),
                                                        by=10)),
                       breaks = seq(min(Tabla_DHI$aport_mean_SMA),
                                    max(Tabla_DHI$aport_mean_SMA),
                                    by=20)) + 
    ggtitle("Nivel y aportación. SMA (24 horas) de la media horaria")
  
ccf_DHI<- ccf(Tabla_DHI$aport_mean_SMA, 
    Tabla_DHI$nivel_mean_SMA, 
    lag.max = 1000)

 print(paste0("Máxima correlacion de ",
               round(max(ccf_DHI$acf), digits = 3) ,
               " .Para un desfase de: ",
               round(ccf_DHI$lag[which.max(ccf_DHI$acf)]/24, digits = 2), 
        " días"))
```
          
```{r include=FALSE}
 k<- max(Tabla_DHI$nivel_SMA)/max(Tabla_DHI$aport_SMA)
 
  ggplot(data=Tabla_DHI, aes(x=Date))+
    geom_line(aes(y=aport_SMA))+
    xlab("Date")+ylab("Aportación [m³/s]")+
    theme(panel.background = element_blank(),
          panel.grid = element_blank())+
    geom_line(aes(y=nivel_SMA/k),group=1, color="red") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k), name = "Nivel [msnm]", 
                                           breaks = seq(min(Tabla_DHI$nivel_SMA),
                                                        max(Tabla_DHI$nivel_SMA),
                                                        by=10)),
                       breaks = seq(min(Tabla_DHI$aport_SMA),
                                    max(Tabla_DHI$aport_SMA),
                                    by=20)) + 
    ggtitle("Nivel y aportación. SMA (96 datos = 1 día) de los datos 15-minutales")

ccf_DHI<- ccf(Tabla_DHI$aport_SMA, 
    Tabla_DHI$nivel_SMA, 
    lag.max = 4000)

 print(paste0("Máxima correlacion de ",
               round(max(ccf_DHI$acf), digits = 3) ,
               " .Para un desfase de: ",
               round(ccf_DHI$lag[which.max(ccf_DHI$acf)]/24, digits = 2), 
        " días"))
```



```{r include=FALSE}
 k<- max(Tabla_DHI$nivel_mean)/max(Tabla_DHI$aport_mean)
 
  ggplot(data=Tabla_DHI, aes(x=Date))+
    geom_line(aes(y=aport_mean))+
    xlab("Date")+ylab("Aportación [m³/s]")+
    theme(panel.background = element_blank(),
          panel.grid = element_blank())+
    geom_line(aes(y=nivel_mean/k),group=1, color="red") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k), name = "Nivel [msnm]", 
                                           breaks = seq(min(Tabla_DHI$nivel_mean),
                                                        max(Tabla_DHI$nivel_mean),
                                                        by=10)),
                       breaks = seq(min(Tabla_DHI$aport_mean),
                                    max(Tabla_DHI$aport_mean),
                                    by=20)) + 
    ggtitle("Nivel y aportación. Medias horarias")

ccf_DHI<- ccf(Tabla_DHI$aport_mean, 
    Tabla_DHI$nivel_mean, 
    lag.max = 1000)

 print(paste0("Máxima correlacion de ",
               round(max(ccf_DHI$acf), digits = 3) ,
               " .Para un desfase de: ",
               round(ccf_DHI$lag[which.max(ccf_DHI$acf)]/24, digits = 2), 
        " días"))
```
```{r include=FALSE}
 k<- max(Tabla_DHI$Lluvia_mm)/max(Tabla_DHI$aport_mean_SMA)
 
  ggplot(data=Tabla_DHI, aes(x=Date))+
    geom_line(aes(y=aport_mean_SMA))+
    xlab("Date")+ylab("Aportación [m³/s]")+
    theme(panel.background = element_blank(),
          panel.grid = element_blank())+
    geom_line(aes(y=Lluvia_mm/k),group=1, color="red") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k), name = "Lluvia Horaria [l/m²]", 
                                           breaks = seq(min(Tabla_DHI$Lluvia_mm),
                                                        max(Tabla_DHI$Lluvia_mm),
                                                        by=10)),
                       breaks = seq(min(Tabla_DHI$aport_mean_SMA),
                                    max(Tabla_DHI$aport_mean_SMA),
                                    by=20)) + 
    ggtitle("Lluvia y aportacion")
  
ccf_DHI<- ccf(Tabla_DHI$aport_mean_SMA, 
    Tabla_DHI$Lluvia_mm, 
    lag.max = 1000)

 print(paste0("Máxima correlacion de ",
               round(max(ccf_DHI$acf), digits = 3) ,
               " .Para un desfase de: ",
               round(ccf_DHI$lag[which.max(ccf_DHI$acf)]/24, digits = 2), 
        " días"))
```
```{r include=FALSE}
Tabla_DHI_cut<- Tabla_DHI[which(month(Tabla_DHI$Date)==12), ]
 k<- max(Tabla_DHI_cut$Lluvia_mm)/max(Tabla_DHI_cut$aport_mean_SMA)
 
  ggplot(data=Tabla_DHI_cut, aes(x=Date))+
    geom_line(aes(y=aport_mean_SMA))+
    xlab("Date")+ylab("Aportación [m³/s]")+
    theme(panel.background = element_blank(),
          panel.grid = element_blank())+
    geom_line(aes(y=Lluvia_mm/k),group=1, color="red") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k), name = "Nivel [msnm]", 
                                           breaks = seq(min(Tabla_DHI_cut$Lluvia_mm),
                                                        max(Tabla_DHI_cut$Lluvia_mm),
                                                        by=10)),
                       breaks = seq(min(Tabla_DHI_cut$aport_mean_SMA),
                                    max(Tabla_DHI_cut$aport_mean_SMA),
                                    by=20)) + 
    ggtitle("Lluvia y aportacion. Diciembre")
  
ccf_DHI<- ccf(Tabla_DHI_cut$aport_mean_SMA, 
    Tabla_DHI_cut$Lluvia_mm, 
    lag.max = 1000)

 print(paste0("Máxima correlacion de ",
               round(max(ccf_DHI$acf), digits = 3) ,
               " .Para un desfase de: ",
               round(ccf_DHI$lag[which.max(ccf_DHI$acf)]/24, digits = 2), 
        " días"))
```
```{r include=FALSE}
Tabla_DHI_cut<- Tabla_DHI[which(month(Tabla_DHI$Date)==12 | year(Tabla_DHI$Date)==2019), ]
 k<- max(Tabla_DHI_cut$Lluvia_mm)/max(Tabla_DHI_cut$aport_mean_SMA)
 
  ggplot(data=Tabla_DHI_cut, aes(x=Date))+
    geom_line(aes(y=aport_mean_SMA))+
    xlab("Date")+ylab("Aportación [m³/s]")+
    theme(panel.background = element_blank(),
          panel.grid = element_blank())+
    geom_line(aes(y=Lluvia_mm/k),group=1, color="red") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k), name = "Nivel [msnm]", 
                                           breaks = seq(min(Tabla_DHI_cut$Lluvia_mm),
                                                        max(Tabla_DHI_cut$Lluvia_mm),
                                                        by=10)),
                       breaks = seq(min(Tabla_DHI_cut$aport_mean_SMA),
                                    max(Tabla_DHI_cut$aport_mean_SMA),
                                    by=20)) + 
    ggtitle("Lluvia y aportacion. Diciembre-Enero-Febrero")
  
ccf_DHI<- ccf(Tabla_DHI_cut$aport_mean_SMA, 
    Tabla_DHI_cut$Lluvia_mm, 
    lag.max = 1000)

 print(paste0("Máxima correlacion de ",
               round(max(ccf_DHI$acf), digits = 3) ,
               " .Para un desfase de: ",
               round(ccf_DHI$lag[which.max(ccf_DHI$acf)]/24, digits = 2), 
        " días"))
```
```{r include=FALSE}

path_dataDHI <- here::here('Data/Parques/Belesar/Historico/DHI_historico_afinado.RDS')

#saveRDS(Tabla_DHI,path_dataDHI)

```

```{r}
#Usamos dplyr para juntar ambos datasets

Belesar_WRF<- readRDS(here::here('Data/Parques/Belesar/Historico/Historico_WRF_Belesar_Variables_D1D2.RDS'))
Belesar_DHI<- readRDS(here::here('Data/Parques/Belesar/Historico/DHI_historico_afinado.RDS'))

df2<- Belesar_DHI

Belesar_Merge<- list()
for (j in 1:length(Belesar_WRF)) {
  lista_retorno<- list()
  for(i in 1:2){
    df1<-  Belesar_WRF[[j]][[i]]
    Merge_table<- left_join(df1, df2, by=c("Date"))
    lista_retorno[[i]]<- Merge_table
  }
  names(lista_retorno)<- c("D1", "D2")
  Belesar_Merge[[j]]<- lista_retorno 
}
names(Belesar_Merge)<- names(Belesar_WRF)

```


```{r include=FALSE}
#Belesar merge completecases
Belesar_Merge_cc<- list()
for (j in 1:length(Belesar_Merge)) {
    lista_retorno<- list()
  for(i in 1:2){
    df1<-  Belesar_Merge[[j]][[i]]
    df1$Acumulated<- NULL
    Table_fine<- df1[complete.cases(df1),]
    lista_retorno[[i]]<- Table_fine
  }
  names(lista_retorno)<- c("D1", "D2")
  Belesar_Merge_cc[[j]]<- lista_retorno 
}
names(Belesar_Merge_cc)<- names(Belesar_Merge)



#Guardamos
path_hist_WRF<- here::here('Data/Parques/Belesar/Historico/Hist_D1D2_DHI_MERGED.RDS')
#saveRDS(Belesar_Merge_cc,path_hist_WRF)

```

<br />
<br />

# Hourly rainfall comparation between observed and estimated

<br />
<br />

This figure shows that ARW-WRF model that we are running is getting good rainfall predicction. 

<br />
<br />


```{r include=FALSE}
#importar
path_hist_WRF<- here::here('Data/Parques/Belesar/Historico/Hist_D1D2_DHI_MERGED.RDS')
clean_data<- readRDS(path_hist_WRF)


#cortar en entrenamiento y predicción
cut_train<- lapply(clean_data, function(x){
  y<- lapply(x, function(r){
    
    fecha_ini<- ymd("2018/10/01")
    fecha_end<- ymd("2019/02/01")
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
})
cut_predict<- lapply(clean_data, function(x){
  y<- lapply(x, function(r){
    
    fecha_ini<- ymd("2019/02/01")
    fecha_end<- ymd("2019/02/20")
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
})

```

```{r include=FALSE}

clean_data_oct<-lapply(clean_data, function(x){
  y<- lapply(x, function(r) {
    r<- r[which(r$Date > ymd("2018/10/01")),]
    r$prep_hourly<- ifelse(r$prep_hourly < 0,0,r$prep_hourly) 
    return(r)
  })
})

```

```{r}

#Plot_rain3 necesita columna Date y columna rain
plot_rain3<- function(data,data2, titulo){
  ggplot(data=data, aes(x=Date))+
    geom_line(aes(y=rain), stat="identity")+
    xlab("Date")+ylab("Hourly rainfall [mm/h]")+
    theme(panel.background = element_blank(),
          panel.grid = element_blank()) +
    geom_line(data= data2, 
              aes(x=Date, y=rain),
              color="red", 
              alpha=0.5)+
    geom_text(aes(as.POSIXct(ymd("2019/02/01")),10, 
                  label=paste0("Cor: ",
                               round(cor(data$rain,
                                         data2$rain),
                                     digits = 2)))) +
    ggtitle(titulo) + 
     theme(plot.title = element_text(hjust = 0.5)) 
  
}

clean_data_jan<-lapply(clean_data_oct, function(x){
  y<- lapply(x, function(r) r[which(r$Date > ymd("2019/01/15") & r$Date < ymd("2019/02/10")),])
})

Cor_rain_place<- data.frame(matrix(ncol = 4))
colnames(Cor_rain_place)<- c("LON", "LAT", "Corr", "Dist")
for (i in 1:length(clean_data_jan)) {
  Corr<- cor(clean_data_jan[[i]][[1]]$prep_hourly, 
             clean_data_jan[[i]][[1]]$Lluvia_mm)
  LON<- as.numeric(str_split(names(clean_data_jan)[i], "_")[[1]][1])
  LAT<- as.numeric(str_split(names(clean_data_jan)[i], "_")[[1]][3])
  Dist<- distm(c(-7.713948, 42.628577), 
               c(as.numeric(LON),
                 as.numeric(LAT)),
               fun = distHaversine)
  Cor_rain_place[i,]<- as.data.frame(cbind(LON, LAT, Corr, Dist))
  
  
}

#Ploteamos los 5 puntos con mejor correlacion
for (i in order(Cor_rain_place$Corr, decreasing = T)[1]) {
  data1<- as.data.frame(cbind(as.character(clean_data_jan[[i]][[1]]$Date),
                              clean_data_jan[[i]][[1]]$prep_hourly))
  
  names(data1)<- c("Date", "rain")
  data1$Date<- ymd_hms(data1$Date)
  data1$rain<- as.numeric(as.character(data1$rain))
  
  
  
  data2<- as.data.frame(cbind(as.character(clean_data_jan[[i]][[1]]$Date),
                              clean_data_jan[[i]][[1]]$Lluvia_mm))
  
  names(data2)<- c("Date", "rain")
  data2$Date<- ymd_hms(data2$Date)
  data2$rain<- as.numeric(as.character(data2$rain))
  
  
  x<- plot_rain3(data = data1 ,
             data2 = data2,
             titulo ="Observed rain (red) vs WRF estimated rain (black)")
  print(x)
  
  
  
  
}

```


```{r include=FALSE}
Daiyli_avgs<- lapply(clean_data_oct, function(x){
  x[[1]] %>% group_by(year(Date), yday(Date)) %>%  
    summarize(rWRF_acum= sum(prep_hourly),
              rDHI_acum= sum(Lluvia_mm),
              rWRF_mean= sum(prep_hourly),
              rDHI_mean= sum(Lluvia_mm),
              aport_SMA_diario=mean(aport_SMA),
              aport_mean_diario=mean(aport_mean),
              aport_mean_SMA_diario=mean(aport_mean_SMA),
              nivel_SMA_diario=mean(nivel_SMA),
              nivel_mean_diario=mean(nivel_mean),
              nivel_mean_SMA_diario=mean(nivel_mean_SMA))

  
  })

Daiyli_avgs2<- lapply(Daiyli_avgs, function(x){
  
  x$Date<- ymd(ifelse(x$`year(Date)`==2018,
                      as.character(as.Date(x$`yday(Date)`, origin= "2018-01-01")),
                      as.character(as.Date(x$`yday(Date)`, origin= "2019-01-01"))))
  x$`year(Date)`<- NULL
  x$`yday(Date)`<- NULL
  return(x)
})

Cor_rain_place<- data.frame(matrix(ncol = 11))
for (i in 1:length(Daiyli_avgs2)) {
  Corr1<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
             Daiyli_avgs2[[i]]$aport_SMA_diario)
  Corr2<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_diario)
  Corr3<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario)
  Corr4<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$rDHI_acum)
  
  Corr5<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_SMA_diario)
  Corr6<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_diario)
  Corr7<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario)
  Corr8<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$rDHI_mean)
  
  LON<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][1])
  LAT<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][3])
  Dist<- distm(c(-7.713948, 42.628577), 
               c(as.numeric(LON),
                 as.numeric(LAT)),
               fun = distHaversine)
  Cor_rain_place[i,]<- as.data.frame(cbind(LON, LAT, round(Corr1, digits = 2),
                                           round(Corr2, digits = 2),
                                           round(Corr3, digits = 2),
                                           round(Corr4, digits = 2),
                                           round(Corr5, digits = 2),
                                           round(Corr6, digits = 2),
                                           round(Corr7, digits = 2),
                                           round(Corr, digits = 2),
                                           Dist))
  
  
}

colnames(Cor_rain_place)<- c("LON","LAT","AWRF_aport1",
                             "AWRF_aport2", "AWRF_aport3",
                             "AWRF_ADHI","MWRF_aport1",
                             "MWRF_aport2", "MWRF_aport3",
                             "MWRF_MDHI","Dist")

```


```{r include=FALSE,  rows.print= length(Cor_rain_place[,1])}
Cor_order<- Cor_rain_place[order(Cor_rain_place$Dist),]
#Cor_order
```
```{r include=FALSE}
Cor_rain_place_ccf<- data.frame(matrix(ncol = 11))
for (i in 1:length(Daiyli_avgs2)) {
  ccfr1<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_SMA_diario, plot = FALSE)
  ccfr2<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_diario, plot = FALSE)
  ccfr3<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario, plot = FALSE)
  ccfr4<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$rDHI_acum, plot = FALSE)
  
  ccfr5<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_SMA_diario, plot = FALSE)
  ccfr6<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_diario, plot = FALSE)
  ccfr7<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario, plot = FALSE)
  ccfr8<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$rDHI_mean, plot = FALSE)
  
  LON<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][1])
  LAT<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][3])
  Dist<- distm(c(-7.713948, 42.628577), 
               c(as.numeric(LON),
                 as.numeric(LAT)),
               fun = distHaversine)
  Cor_rain_place_ccf[i,]<- as.data.frame(cbind(LON, LAT, 
                                               round(max(ccfr1$acf), digits = 2),
                                               round(max(ccfr2$acf), digits = 2),
                                               round(max(ccfr3$acf), digits = 2),
                                               round(max(ccfr4$acf), digits = 2),
                                               round(max(ccfr5$acf), digits = 2),
                                               round(max(ccfr6$acf), digits = 2),
                                               round(max(ccfr7$acf), digits = 2),
                                               round(max(ccfr8$acf), digits = 2), Dist))
  print(paste("Mejor corr para un retardo de: ", 
              ccfr1$lag[which.max(ccfr1$acf)],
              ccfr2$lag[which.max(ccfr2$acf)],
              ccfr3$lag[which.max(ccfr3$acf)],
              ccfr4$lag[which.max(ccfr4$acf)],
              ccfr5$lag[which.max(ccfr5$acf)],
              ccfr6$lag[which.max(ccfr6$acf)],
              ccfr7$lag[which.max(ccfr7$acf)],
              ccfr8$lag[which.max(ccfr8$acf)], sep = " "))  
  
}

colnames(Cor_rain_place_ccf)<-  c("LON","LAT","AWRF_aport1",
                                  "AWRF_aport2", "AWRF_aport3",
                                  "AWRF_ADHI","MWRF_aport1",
                                  "MWRF_aport2","MWRF_aport3",
                                  "MWRF_MDHI","Dist")

```

```{r include=FALSE,  rows.print= length(Cor_rain_place_ccf[,1])}
Cor_order<- Cor_rain_place_ccf[order(Cor_rain_place_ccf$Dist),]
#Cor_order
```
```{r include=FALSE}

clean_data_dec<-lapply(clean_data, function(x){
  y<- lapply(x, function(r) r[which(r$Date > ymd("2018/12/01")),])
})
Daiyli_avgs<- lapply(clean_data_dec, function(x){
  x[[1]] %>% group_by(year(Date), yday(Date)) %>%  
    summarize(rWRF_acum= sum(prep_hourly),
              rDHI_acum= sum(Lluvia_mm),
              rWRF_mean= sum(prep_hourly),
              rDHI_mean= sum(Lluvia_mm),
              aport_SMA_diario=mean(aport_SMA),
              aport_mean_diario=mean(aport_mean),
              aport_mean_SMA_diario=mean(aport_mean_SMA),
              nivel_SMA_diario=mean(nivel_SMA),
              nivel_mean_diario=mean(nivel_mean),
              nivel_mean_SMA_diario=mean(nivel_mean_SMA))

  
  })

Daiyli_avgs2<- lapply(Daiyli_avgs, function(x){
  
  x$Date<- ymd(ifelse(x$`year(Date)`==2018,
                      as.character(as.Date(x$`yday(Date)`, origin= "2018-01-01")),
                      as.character(as.Date(x$`yday(Date)`, origin= "2019-01-01"))))
  x$`year(Date)`<- NULL
  x$`yday(Date)`<- NULL
  return(x)
})

Cor_rain_place<- data.frame(matrix(ncol = 11))
for (i in 1:length(Daiyli_avgs2)) {
  Corr1<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
             Daiyli_avgs2[[i]]$aport_SMA_diario)
  Corr2<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_diario)
  Corr3<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario)
  Corr4<- cor(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$rDHI_acum)
  
  Corr5<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_SMA_diario)
  Corr6<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_diario)
  Corr7<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario)
  Corr8<- cor(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$rDHI_mean)
  
  LON<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][1])
  LAT<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][3])
  Dist<- distm(c(-7.713948, 42.628577), 
               c(as.numeric(LON),
                 as.numeric(LAT)),
               fun = distHaversine)
  Cor_rain_place[i,]<- as.data.frame(cbind(LON, LAT, round(Corr1, digits = 2),
                                           round(Corr2, digits = 2),
                                           round(Corr3, digits = 2),
                                           round(Corr4, digits = 2),
                                           round(Corr5, digits = 2),
                                           round(Corr6, digits = 2),
                                           round(Corr7, digits = 2),
                                           round(Corr, digits = 2),
                                           Dist))
  
  
}

colnames(Cor_rain_place)<- c("LON","LAT","AWRF_aport1",
                             "AWRF_aport2", "AWRF_aport3",
                             "AWRF_ADHI","MWRF_aport1",
                             "MWRF_aport2", "MWRF_aport3",
                             "MWRF_MDHI","Dist")

```
```{r include=FALSE,  rows.print= length(Cor_rain_place[,1])}
Cor_order<- Cor_rain_place[order(Cor_rain_place$Dist),]
#Cor_order
```
```{r include=FALSE}
Cor_rain_place_ccf<- data.frame(matrix(ncol = 11))
for (i in 1:length(Daiyli_avgs2)) {
  ccfr1<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_SMA_diario, plot = FALSE)
  ccfr2<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_diario, plot = FALSE)
  ccfr3<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario, plot = FALSE)
  ccfr4<- ccf(Daiyli_avgs2[[i]]$rWRF_acum, 
              Daiyli_avgs2[[i]]$rDHI_acum, plot = FALSE)
  
  ccfr5<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_SMA_diario, plot = FALSE)
  ccfr6<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_diario, plot = FALSE)
  ccfr7<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$aport_mean_SMA_diario, plot = FALSE)
  ccfr8<- ccf(Daiyli_avgs2[[i]]$rWRF_mean, 
              Daiyli_avgs2[[i]]$rDHI_mean, plot = FALSE)
  
  LON<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][1])
  LAT<- as.numeric(str_split(names(Daiyli_avgs2)[i], "_")[[1]][3])
  Dist<- distm(c(-7.713948, 42.628577), 
               c(as.numeric(LON),
                 as.numeric(LAT)),
               fun = distHaversine)
  Cor_rain_place_ccf[i,]<- as.data.frame(cbind(LON, LAT, 
                                               round(max(ccfr1$acf), digits = 2),
                                               round(max(ccfr2$acf), digits = 2),
                                               round(max(ccfr3$acf), digits = 2),
                                               round(max(ccfr4$acf), digits = 2),
                                               round(max(ccfr5$acf), digits = 2),
                                               round(max(ccfr6$acf), digits = 2),
                                               round(max(ccfr7$acf), digits = 2),
                                               round(max(ccfr8$acf), digits = 2), Dist))
  print(paste("Mejor corr para un retardo de: ", 
              ccfr1$lag[which.max(ccfr1$acf)],
              ccfr2$lag[which.max(ccfr2$acf)],
              ccfr3$lag[which.max(ccfr3$acf)],
              ccfr4$lag[which.max(ccfr4$acf)],
              ccfr5$lag[which.max(ccfr5$acf)],
              ccfr6$lag[which.max(ccfr6$acf)],
              ccfr7$lag[which.max(ccfr7$acf)],
              ccfr8$lag[which.max(ccfr8$acf)], sep = " "))  
  
}

colnames(Cor_rain_place_ccf)<-  c("LON","LAT","AWRF_aport1",
                                  "AWRF_aport2", "AWRF_aport3",
                                  "AWRF_ADHI","MWRF_aport1",
                                  "MWRF_aport2","MWRF_aport3",
                                  "MWRF_MDHI","Dist")

```
```{r include=FALSE}
clean_data_oct<-lapply(clean_data, function(x){
  y<- lapply(x, function(r) {
    r<- r[which(r$Date > ymd("2018/10/01")),]
    r$prep_hourly<- ifelse(r$prep_hourly < 0,0,r$prep_hourly) 
    return(r)
  })
})
Daiyli_avgs<- lapply(clean_data_oct, function(x){
  x[[1]] %>% group_by(year(Date), yday(Date)) %>%  
    summarize(rWRF_acum= sum(prep_hourly),
              rDHI_acum= sum(Lluvia_mm),
              rWRF_mean= sum(prep_hourly),
              rDHI_mean= sum(Lluvia_mm),
              aport_SMA_diario=mean(aport_SMA),
              aport_mean_diario=mean(aport_mean),
              aport_mean_SMA_diario=mean(aport_mean_SMA),
              nivel_SMA_diario=mean(nivel_SMA),
              nivel_mean_diario=mean(nivel_mean),
              nivel_mean_SMA_diario=mean(nivel_mean_SMA))

  
  })

Daiyli_avgs2<- lapply(Daiyli_avgs, function(x){
  
  x$Date<- ymd(ifelse(x$`year(Date)`==2018,
                      as.character(as.Date(x$`yday(Date)`, origin= "2018-01-01")),
                      as.character(as.Date(x$`yday(Date)`, origin= "2019-01-01"))))
  x$`year(Date)`<- NULL
  x$`yday(Date)`<- NULL
  return(x)
})

Daiyli_avgs3<-lapply(Daiyli_avgs2[c(19,23,24,14)], function(x)x[, c("Date","rWRF_acum",
                                      "aport_mean_SMA_diario", 
                                      "rDHI_acum")])


#head(Daiyli_avgs3[[1]])

#range(Daiyli_avgs3[[1]]$Date)

```
```{r include=FALSE}

lapply(Daiyli_avgs3, function(x, titulo){
   k<- (max(c(cumsum(x$rWRF_acum),cumsum(x$rWRF_acum)))/max(c(x$rWRF_acum, x$rDHI_acum)))
  ggplot(data=x, aes(x=Date))+
    geom_bar(aes(y=rWRF_acum), stat="identity", fill="red", alpha=0.5, size=0.05)+
    xlab("Date")+ylab("Lluvia diaria [mm/h]")+theme(panel.background = element_blank(), 
                                                      panel.grid = element_blank())+
    geom_line(aes(y = cumsum(rWRF_acum)/k), group = 1, col="red") +
    geom_bar(aes(y=rDHI_acum), stat="identity", fill="blue", alpha=0.4, size=0.05)+
    xlab("Date")+ylab("Lluvia diaria [mm/h]")+
    theme(panel.background = element_blank(),panel.grid = element_blank())+
    geom_line(aes(y = cumsum(rDHI_acum)/k), group = 1, col="blue") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k),
                                           name = " LLuvia acumulada [mm]", 
                                           breaks = seq(min(cumsum(x$rDHI_acum)),
                                                        max(cumsum(x$rDHI_acum)),
                                                        by=50)),
                       breaks = seq(min(x$rDHI_acum),
                                    max(x$rDHI_acum),
                                    by=10))+
    ggtitle(titulo) +
    theme(plot.title = element_text(hjust = 0.5))

}, titulo=names(Daiyli_avgs3))
 

```
```{r include=FALSE}
vec_diff<- as.vector(unlist(lapply(Daiyli_avgs2, function(x){
  r<- sum(x$rWRF_acum)-sum(x$rDHI_acum)
  return(r)
})))

#vec_diff[order(abs(vec_diff))]

```
```{r include=FALSE}
best_points<- order(abs(vec_diff))[1:10][order(abs(vec_diff))[1:10]%in%order(Cor_rain_place_ccf$AWRF_aport3, decreasing = T)[1:10]]

best_points
```
```{r include=FALSE}
litros_acum_diff<- vec_diff[best_points]
#cbind(litros_acum_diff,Cor_rain_place_ccf[best_points,c("AWRF_aport3","AWRF_ADHI", "Dist")])

```
```{r include=FALSE}
Daiyli_avgs4<-lapply(Daiyli_avgs2[c(14,18,19)], function(x)x[, c("Date","rWRF_acum",
                                      "aport_mean_SMA_diario", 
                                      "rDHI_acum")])



```
<br />
<br />
<br />
<br />



# Daily rainfall comparation between observed and estimated, cumulative and streamflow. 


<br />
<br />

This figure shows that WRF model is even better in the daily rainfall estimation and also in the total cumulative rain. Also, this figure shows that the streamflow is highly correlated whith the rainfall with some lag. 
<br />
<br />

```{r echo=FALSE,results='hide',fig.keep='all'}
lapply(Daiyli_avgs4[1], function(x, titulo){
   k<- (max(c(cumsum(x$rWRF_acum),cumsum(x$rWRF_acum)))/max(c(x$rWRF_acum, x$rDHI_acum)))
  ggplot(data=x, aes(x=ymd(Date)))+
    geom_bar(aes(y=rWRF_acum), stat="identity", fill="black", alpha=0.5, size=0.05)+
    xlab("Date")+ylab("Lluvia diaria [mm/h]")+theme(panel.background = element_blank(), 
                                                      panel.grid = element_blank())+
    geom_line(aes(y = cumsum(rWRF_acum)/k), group = 1, col="black") +
    geom_bar(aes(y=rDHI_acum), stat="identity", fill="red", alpha=0.4, size=0.05)+
    xlab("Date")+ylab("Daily rain [mm/day]")+
    theme(panel.background = element_blank(),panel.grid = element_blank())+
    geom_line(aes(y = cumsum(rDHI_acum)/k), group = 1, col="red") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~ . / (1/k),
                                           name = " Cumulative rain [mm]", 
                                           breaks = seq(min(cumsum(x$rDHI_acum)),
                                                        max(cumsum(x$rDHI_acum)),
                                                        by=50)),
                       breaks = seq(min(x$rDHI_acum),
                                    max(x$rDHI_acum),
                                    by=10))+
    ggtitle(titulo) +
    theme(plot.title = element_text(hjust = 0.5))+
    geom_line(aes(y=aport_mean_SMA_diario/k), col="green",alpha= 0.9)

}, titulo="Observed rain (red) vs WRF estimated rain (black) \n Observed Streamflow (green)")
```
```{r include=FALSE}
RDS_down_path<- list.files(here::here('Data/Parques/Belesar/Historico/WEB'), 
                           full.names = T) %>%
  .[str_detect(.,"WRF_WEB_")] %>% .[str_detect(., ":")]


download_day<- sapply(str_split(RDS_down_path, "_"), 
                      function(x) paste0(x[3], " ",
                                         str_remove(x[4], ".RDS")))%>%  ymd_hms(.)


clean_data<- readRDS(RDS_down_path[which.max(download_day)])
clean_data1<- lapply(clean_data, function(x){
  y<- lapply(x, function(r){
    r$dif_nivel<- c(diff(r$nivel)[],0)
    r$dif_nivel[diff(r$Date)>3600]<- 0
    return(r)
  })
})

fecha_cut<- ymd("2019/04/15")
#cortar en entrenamiento y predicción
cut_train<- lapply(clean_data1, function(x,fecha_end){
  y<- lapply(x, function(r){
    
    
    fecha_ini<- ymd("2018/12/01")
    
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
},
fecha_end=fecha_cut)
cut_train<- lapply(cut_train, function(x){
  r<- x[[1]][,c("Date","LON", "LAT", "prep_hourly", "lluvia", 
            "nivel", "dif_nivel")]
  return(r[complete.cases(r),])
  
})


cut_predict<- lapply(clean_data1, function(x, fecha_ini){
  y<- lapply(x, function(r){
    Jan_data<- r[which(r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
}, 
fecha_ini=fecha_cut)
cut_predict<- lapply(cut_predict, function(x){
  r<- x[[1]][,c("Date","LON", "LAT", "prep_hourly", "lluvia",
            "nivel", "dif_nivel")]
  return(r[complete.cases(r), ])
  
})

#Miramos cual es el SMA optimo en lo que se refiere a lluvia
# WRF correlacionando con diferencia de nivel
x<- lapply(cut_train, function(x){
  cases<- expand.grid(seq(6,48,6),seq(6,48,6))
  max_cor<- vector()
  lag_maxcor<- vector()
  cor_table<- as.data.frame(matrix(ncol=4))
  for (i in 1:length(cases[,1])) {
    prueba<- x
    prueba$SMA_prep<- SMA(prueba$prep_hourly,cases[i,1])
    prueba$SMA_difnivel<- SMA(prueba$dif_nivel, cases[i,2])
    prueba<- prueba[complete.cases(prueba),]
    
    r<- ccf(prueba$SMA_prep,prueba$SMA_difnivel,lag.max = 1000, plot = F)
    max_cor[i]<- max(r$acf)
    lag_maxcor[i]<- r$lag[which.max(r$acf)]
  }
  #cat("Best cor of: ", max(max_cor),"SMA_lluvia= ",cases[which.max(max_cor),1], "SMA_nivel= ",cases[which.max(max_cor),2],"lag= ", lag_maxcor[which.max(max_cor)])
  cor_table<-cbind(max(max_cor), 
                       lag_maxcor[which.max(max_cor)],
                       cases[which.max(max_cor),1],
                       cases[which.max(max_cor),2]) 
  colnames(cor_table)<- c("Max","lag","SMA_lluvia","SMA_difnivel")
  return(cor_table)
})

x1<- as.data.frame(matrix(unlist(x), ncol = 4, byrow = T))
colnames(x1)<- colnames(x[[1]])
```
```{r include=FALSE}
for (i in c(23,17,22,18)) {
  prueba<- cut_train[[i]]
prueba$SMA_prep<- SMA(prueba$prep_hourly,48)
prueba$SMA_difnivel<- SMA(prueba$dif_nivel, 36)
prueba<- prueba[complete.cases(prueba),]

r<- ccf(prueba$SMA_prep,prueba$SMA_difnivel,
        lag.max = 1000)
  
}
```
```{r include=FALSE}
plot(r$acf, x= r$lag, 
     xlim = c(-72,72),
     xlab = "lag",
     ylab = "cor",
     main = "Cross-correlation punto 18")
```
```{r include=FALSE}

plot(prueba$SMA_prep,
     x=prueba$Date, 
     type = "l", 
     ylim = c(-0.5, 1),
     xlab = "Date", 
     ylab = "Rain WRF",
     main = "Rain WRF (black) \n Diff nivel * 15 (red)")
lines(prueba$SMA_difnivel*15,
      x=prueba$Date, col="red")

```
```{r include=FALSE}
path_hist_WRF<- here::here('Data/Parques/Belesar/Historico/Hist_D1D2_DHI_MERGED.RDS')
clean_data<- readRDS(path_hist_WRF)
clean_data_oct<-lapply(clean_data, function(x){
  y<- lapply(x, function(r) r[which(r$Date > ymd("2018/10/01")),])
})


fecha_cut<- ymd("2019/01/15")
#cortar en entrenamiento y predicción
cut_train<- lapply(clean_data_oct[c(14,18,19)], function(x,fecha_end){
  y<- lapply(x, function(r){
    
    fecha_ini<- ymd("2018/12/01")
    
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
},
fecha_end=fecha_cut)
cut_train<- lapply(cut_train, function(x){
  x[[1]][,c("Date","LON", "LAT", "prep_hourly", "Lluvia_mm", 
            "aport_mean_SMA", "nivel_mean_SMA")]
  
  
})


cut_predict<- lapply(clean_data_oct[c(14,18,19)], function(x, fecha_ini){
  y<- lapply(x, function(r){
    
    
    fecha_end<- ymd("2019/02/20")
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
}, 
fecha_ini=fecha_cut)
cut_predict<- lapply(cut_predict, function(x){
  x[[1]][,c("Date","LON", "LAT", "prep_hourly", "Lluvia_mm", 
            "aport_mean_SMA", "nivel_mean_SMA")]
  
  
})


```
```{r include=FALSE}
x<- cut_train[[1]]
plot(diff(x$nivel_mean_SMA)*20,  
     ylim = c(-1.5,2), 
     type = "l", 
     xlab = "",
     xaxt="n",
     yaxt="n",
     ylab = " ")
lines(x$aport_mean_SMA/100-1, col="red")
```
```{r include=FALSE}
xx<- x[which(x$Date> ymd("2018/12/10")),]  
plot(diff(xx$nivel_mean_SMA)*20,  
     ylim = c(-1.5,2), 
     type = "l", 
     xlab = "",
     xaxt="n",
     yaxt="n",
     ylab = " ")
lines(xx$aport_mean_SMA/100-1, col="red")

```
```{r include=FALSE}
ccf_nivel_aport<- ccf(diff(xx$nivel_mean_SMA),
                      xx$aport_mean_SMA,
                      lag.max = 1000)

print(paste0("Correlación máxima: ",
             max(ccf_nivel_aport$acf), " Se produce para un retraso de ",
             ccf_nivel_aport$lag[
               which.max(ccf_nivel_aport$acf)], " horas"))
```
```{r include=FALSE}
vec_cor<- vector()

for (i in seq(6, 144, by=2)) {
  x<- cut_train[[1]]
  x$prep_hourlySMA<- SMA(x$prep_hourly, i)
  x<- x[complete.cases(x),]

  rain_aport<- ccf(x$prep_hourlySMA, 
      x$aport_mean_SMA, 
      lag.max = 1000, 
      plot = F)
  
  vec_cor[i]<- max(rain_aport$acf)
  
  
}

plot(vec_cor, 
     xlab = "SMA points",
     ylab = "Corr")

```

# Dam level and streamflow prediccion using basic machine learning techniques 


<br />
<br />

Next figures shows that, because of the high correlation between WRF rainfall stimation and streamflow, we are able to make an accurate short term prediction using different regression techniques. for the estimation of the level variation of the dam and also the streamflow reaching the dam. 
<br />
<br />

```{r}
path_hist_WRF<- here::here('Data/Parques/Belesar/Historico/Hist_D1D2_DHI_MERGED.RDS')
clean_data<- readRDS(path_hist_WRF)
clean_data_oct<-lapply(clean_data, function(x){
  y<- lapply(x, function(r){ 
    r<- r[which(r$Date > ymd("2018/10/01")),]
  r$nivel_mean_SMA1<- c(diff(r$nivel_mean_SMA),0)
  return(r)
  })
})


fecha_cut<- ymd("2019/01/15")
#cortar en entrenamiento y predicción
cut_train<- lapply(clean_data_oct[c(14,18,19)], function(x,fecha_end){
  y<- lapply(x, function(r){
    
    fecha_ini<- ymd("2018/12/01")
    
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
},
fecha_end=fecha_cut)
cut_train<- lapply(cut_train, function(x){
  x[[1]][,c("Date","LON", "LAT", "prep_hourly", "Lluvia_mm", 
            "aport_mean_SMA", "nivel_mean_SMA","nivel_mean_SMA1")]
  
  
})


cut_predict<- lapply(clean_data_oct[c(14,18,19)], function(x, fecha_ini){
  y<- lapply(x, function(r){
    
    
    fecha_end<- ymd("2019/02/20")
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
}, 
fecha_ini=fecha_cut)
cut_predict<- lapply(cut_predict, function(x){
  x[[1]][,c("Date","LON", "LAT", "prep_hourly", "Lluvia_mm", 
            "aport_mean_SMA", "nivel_mean_SMA","nivel_mean_SMA1")]
  
  
})


x<- cut_train[[1]]
x$nivel1<- lag(x$nivel_mean_SMA1, 24)
x$nivel2<- lag(x$nivel_mean_SMA1, 48)
x$nivel3<- lag(x$nivel_mean_SMA1, 72)
x$nivel4<- lag(x$nivel_mean_SMA1, 96)
x$nivel5<- lag(x$nivel_mean_SMA1, 120)

x$prep_hourly1<- lead(x$prep_hourly, 24)
x$prep_hourlySMA12<- SMA(x$prep_hourly, 12)
x$prep_hourlySMA24<- SMA(x$prep_hourly, 24)
x$prep_hourlySMA36<- SMA(x$prep_hourly, 36)
x$prep_hourlySMA48<- SMA(x$prep_hourly, 48)
x$prep_hourlySMA48_lag<- lag(x$prep_hourlySMA48, 24)

x<- x[complete.cases(x),]


y<- cut_predict[[1]]
y$nivel1<- lag(y$nivel_mean_SMA1, 24)
y$nivel2<- lag(y$nivel_mean_SMA1, 48)
y$nivel3<- lag(y$nivel_mean_SMA1, 72)
y$prep_hourly1<- lead(y$prep_hourly, 24)
y$prep_hourlySMA12<- SMA(y$prep_hourly, 12)
y$prep_hourlySMA24<- SMA(y$prep_hourly, 24)
y$prep_hourlySMA36<- SMA(y$prep_hourly, 36)
y$prep_hourlySMA48<- SMA(y$prep_hourly, 48)
y$prep_hourlySMA48_lag<- lag(y$prep_hourlySMA48, 24)

y<- y[complete.cases(y),]

indexxx<- 285
fecha_ini<- y$Date[indexxx]
fecha_end<- y$Date[indexxx]+ as.difftime(3, units = "days")

y<- y[which(y$Date> fecha_ini & y$Date< fecha_end), ]





fit_4  <- lm(nivel_mean_SMA1 ~ prep_hourlySMA48_lag * prep_hourlySMA48, data = x)
fit_5  <- lm(nivel_mean_SMA1  ~ prep_hourlySMA48_lag + nivel3 + prep_hourlySMA48, data = x)
fit_6  <- lm(nivel_mean_SMA1  ~ prep_hourlySMA48_lag * nivel3 * prep_hourlySMA48, data = x)

pred_nivel4<- predict(fit_4, data.frame(prep_hourlySMA48_lag =y$prep_hourlySMA48_lag,
                                        prep_hourlySMA48 =y$prep_hourlySMA48))
pred_nivel5<- predict(fit_5, data.frame(prep_hourlySMA48_lag =y$prep_hourlySMA48_lag,
                                        nivel3= y$nivel3,
                                        prep_hourlySMA48 =y$prep_hourlySMA48))
pred_nivel6<- predict(fit_6, data.frame(prep_hourlySMA48_lag =y$prep_hourlySMA48_lag,
                                        nivel3= y$nivel3,
                                        prep_hourlySMA48 =y$prep_hourlySMA48))

uncorrected<- y$nivel_mean_SMA1

plot(uncorrected, x=y$Date, type = "l",ylim=c(0, 0.2),
     xlab = paste0(range(y$Date)),
     ylab = "Level variation [m]",
     main =  "Dam level variation prediction \n using common regression methods")
lines(pred_nivel4,x=y$Date, col="red", lty=2)
lines(pred_nivel5,x=y$Date, col="green", lty=2)
lines(pred_nivel6,x=y$Date,col="blue", lty=2)

```
<br />
<br />
<br />
<br />
```{r }
path_hist_WRF<- here::here('Data/Parques/Belesar/Historico/Hist_D1D2_DHI_MERGED.RDS')
clean_data<- readRDS(path_hist_WRF)
clean_data_oct<-lapply(clean_data, function(x){
  y<- lapply(x, function(r) r[which(r$Date > ymd("2018/10/01")),])
})


fecha_cut<- ymd("2019/01/15")
#cortar en entrenamiento y predicción
cut_train<- lapply(clean_data_oct[c(14,18,19)], function(x,fecha_end){
  y<- lapply(x, function(r){
    
    fecha_ini<- ymd("2018/12/01")
    
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
},
fecha_end=fecha_cut)
cut_train<- lapply(cut_train, function(x){
  x[[1]][,c("Date","LON", "LAT", "prep_hourly", "Lluvia_mm", 
            "aport_mean_SMA", "nivel_mean_SMA")]
  
  
})


cut_predict<- lapply(clean_data_oct[c(14,18,19)], function(x, fecha_ini){
  y<- lapply(x, function(r){
    
    
    fecha_end<- ymd("2019/02/20")
    Jan_data<- r[which(r$Date<fecha_end & r$Date>fecha_ini),]
    return(Jan_data)
    
  })
  return(y)
}, 
fecha_ini=fecha_cut)
cut_predict<- lapply(cut_predict, function(x){
  x[[1]][,c("Date","LON", "LAT", "prep_hourly", "Lluvia_mm", 
            "aport_mean_SMA", "nivel_mean_SMA")]
  
  
})


x<- cut_train[[1]]
x$aport1<- lag(x$aport_mean_SMA, 24)
x$aport2<- lag(x$aport_mean_SMA, 48)
x$aport3<- lag(x$aport_mean_SMA, 72)
x$aport4<- lag(x$aport_mean_SMA, 96)
x$aport5<- lag(x$aport_mean_SMA, 120)

x$prep_hourly1<- lead(x$prep_hourly, 24)
x$prep_hourlySMA12<- SMA(x$prep_hourly, 12)
x$prep_hourlySMA24<- SMA(x$prep_hourly, 24)
x$prep_hourlySMA36<- SMA(x$prep_hourly, 36)
x$prep_hourlySMA48<- SMA(x$prep_hourly, 48)
x$prep_hourlySMA48_lag<- lag(x$prep_hourlySMA48, 24)

x<- x[complete.cases(x),]


y<- cut_predict[[1]]
y$aport1<- lag(y$aport_mean_SMA, 24)
y$aport2<- lag(y$aport_mean_SMA, 48)
y$aport3<- lag(y$aport_mean_SMA, 72)
y$prep_hourly1<- lead(y$prep_hourly, 24)
y$prep_hourlySMA12<- SMA(y$prep_hourly, 12)
y$prep_hourlySMA24<- SMA(y$prep_hourly, 24)
y$prep_hourlySMA36<- SMA(y$prep_hourly, 36)
y$prep_hourlySMA48<- SMA(y$prep_hourly, 48)
y$prep_hourlySMA48_lag<- lag(y$prep_hourlySMA48, 24)

y<- y[complete.cases(y),]

indexxx<- 285
fecha_ini<- y$Date[indexxx]
fecha_end<- y$Date[indexxx]+ as.difftime(3, units = "days")

y<- y[which(y$Date> fecha_ini & y$Date< fecha_end), ]


fit_4  <- lm(aport_mean_SMA ~ prep_hourlySMA48_lag * prep_hourlySMA48, data = x)
fit_5  <- lm(aport_mean_SMA  ~ prep_hourlySMA48_lag + aport3 + prep_hourlySMA48, data = x)
fit_6  <- lm(aport_mean_SMA  ~ prep_hourlySMA48_lag * aport3 * prep_hourlySMA48, data = x)


uncorrected<-y$aport_mean_SMA

pred_aport4<- predict(fit_4, data.frame(prep_hourlySMA48_lag =y$prep_hourlySMA48_lag,
                                        prep_hourlySMA48 =y$prep_hourlySMA48))
pred_aport5<- predict(fit_5, data.frame(prep_hourlySMA48_lag =y$prep_hourlySMA48_lag,
                                        aport3= y$aport3,
                                        prep_hourlySMA48 =y$prep_hourlySMA48))
pred_aport6<- predict(fit_6, data.frame(prep_hourlySMA48_lag =y$prep_hourlySMA48_lag,
                                        aport3= y$aport3,
                                        prep_hourlySMA48 =y$prep_hourlySMA48))


plot(uncorrected, x=y$Date, type = "l",
     ylim = c(0,600), 
     xlab = paste0(range(y$Date)),
     ylab = "Streamflow [m³/s]",
     main =  "Streamflow prediction \n using common regression methods")
lines(pred_aport4,x=y$Date, col="red", lty=2)
lines(pred_aport5,x=y$Date, col="green", lty=2)
lines(pred_aport6,x=y$Date,col="blue", lty=2)


```
```{r include=FALSE}
library(doMC)
library(caret)

x<- getModelInfo()
type<- lapply(x, function(y) {if(length(y$type > 1)){
  return(paste(y$type, collapse = "_"))
}else{return(y$type)}})

label<- lapply(x, function(y) y$label)


Tabla_method<- as.data.frame(cbind(names(x),
                                   unlist(type), 
                                   unlist(label)) , row.names = F) 
colnames(Tabla_method)<- c("Method", "type", "Long-name")

Tabla_both<- Tabla_method[which(str_detect(Tabla_method$type, 
                                           "Regression")),] %>% 
  .[str_detect(.$type,"_"),]

Tabla_regresion<- Tabla_method[which(str_detect(Tabla_method$type, 
                                                "Regression")),] %>% 
  .[!str_detect(.$type,"_"),]


```
<br />
<br />
<br />
<br />

# Dam level and streamflow prediccion using complex machine learning algorithms 

<br />
<br />
All the tests needed are not actually made but,the next figure shows that in preliminary test good results are achieved.  **It's important to adjust some parameters meticulously and also test with different input variables before get the final predictivie model.**
<br />
<br />

```{r}
#here::here('Data/Parques/Belesar/Belesarinflow.csv')
CSV_weka<-read.table( "/home/asus/MB/Data/Parques/Belesar/Belesarinflow.csv", 
                      sep = ";",header = T)

gg_graph<- ggplot(data = CSV_weka)+
  ylab("Dam level variation [m]")+
  xlab("Date")+
  ggtitle("Inflow  prediction")+
  labs(subtitle = "Actual Inflow  (black) \nPredicted inflow (red)")+
  geom_line(aes(y=actual, x=1:length(actual)), 
            col="black")+
  geom_line(aes(y=predicted, x=1:length(predicted)), 
            col="red", lty=1, alpha=0.6)+
  theme_light()+theme(plot.title = element_text(hjust = 0.5))

print(gg_graph)
```

