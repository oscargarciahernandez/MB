---
title: "TAMAULIPAS AN√ÅLISIS POR DOMINIOS"
author: "Oscar Garcia Hernandez"
date: "20/8/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# INTRODUCCION

En este informe se pretende comprobar el funcionamiento del modelo para el parque de Tamaulipas en 1 mes. Teniendo 3 Dominios en los que se aumenta la correlacion. 

```{r fig.width=10, fig.height=10, echo=FALSE, message=FALSE, results='hide'}
library(here)
source(here::here('libraries.R'))
library(tools)
library(maps)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)

PATH_TO_CSVS<- '/media/oscar/14002CD4002CBF1C/tamaulipas/'


CSV_FILES<- list.files(PATH_TO_CSVS, recursive = T, full.names = T) %>% .[str_detect(., '.csv')]

CSV_FILES_D01<- CSV_FILES %>% .[str_detect(., 'D01')]
CSV_FILES_D02<- CSV_FILES %>% .[str_detect(., 'D02')]
CSV_FILES_D03<- CSV_FILES %>% .[str_detect(., 'D03')]


DATA_SIM_D01<-CSV_FILES_D01[1] %>% read.csv(header = T)
DATA_SIM_D02<-CSV_FILES_D02[1] %>% read.csv(header = T)
DATA_SIM_D03<-CSV_FILES_D03[1] %>% read.csv(header = T)

COORD_SIM_D01<- DATA_SIM_D01[,c("LON", 'LAT')] %>% unique()
COORD_SIM_D02<- DATA_SIM_D02[,c("LON", 'LAT')] %>% unique()
COORD_SIM_D03<- DATA_SIM_D03[,c("LON", 'LAT')] %>% unique()


world <- ne_countries(scale = "medium", returnclass = "sf")
states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
states$ID <- toTitleCase(states$ID)
states <- cbind(states, st_coordinates(st_centroid(states)))

incr= 0.05
ggplot(data = world) +
  geom_sf()+
  geom_sf(data = states, fill = NA) + 
  geom_text(data = states, aes(X, Y, label = ID), size = 5)+
  geom_point(data=COORD_SIM_D01 , aes(x= LON, y= LAT), color= "red")+
  geom_point(data=COORD_SIM_D02 , aes(x= LON, y= LAT), color= "green", size= 0.7)+
  geom_point(data=COORD_SIM_D03 , aes(x= LON, y= LAT), color= "orange", size = 0.4)+
  
  coord_sf(xlim = c(min(COORD_SIM_D01$LON) - incr , max(COORD_SIM_D01$LON) + incr), 
           ylim = c(min(COORD_SIM_D01$LAT) - incr , max(COORD_SIM_D01$LAT) + incr), expand = FALSE)
theme_light()



```

```{r fig.width=10, fig.height=10, echo=FALSE, message=FALSE, results='hide'}
library(rasterVis)
library(elevatr)

LON_TNK<- -98.196080
LAT_TNK<- 25.78788


n=max(COORD_SIM_D01$LAT) 
s=min(COORD_SIM_D01$LAT)    
e=max(COORD_SIM_D01$LON)    
w=min(COORD_SIM_D01$LON) 

incr<- 0.0005


if(n > 0){n<- n + incr}else{n<- n + incr}
if(s > 0){s<- s - incr}else{s<- s- incr}
if(e > 0){e<- e + incr}else{e<- e + incr}
if(w > 0){w<- w - incr}else{w<- w- incr}



ul <- round(c(n,w),digits = 2)  #Upper Left
lr <- round(c(s,e), digits = 2)  #Lower Right


lon_location<- seq(lr[1],ul[1],length.out = 100 ) 
lat_location<- seq(ul[2],lr[2], length.out = 100)
data_loc<- expand.grid(lat_location,lon_location)
colnames(data_loc)<- c("x", "y")

spdf <- SpatialPointsDataFrame(coords = data_loc, data = data_loc,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

if(!dir.exists(here::here('Mapas/Raster_TAMAULIPAS/'))){dir.create(here::here('Mapas/Raster_TAMAULIPAS/'), recursive = T)}

if(file.exists(here::here('Mapas/Raster_TAMAULIPAS/map_raster1.RDS'))){
  map_raster1<- readRDS(here::here('Mapas/Raster_TAMAULIPAS/map_raster1.RDS'))
}else{
  map_raster1<- get_elev_raster(spdf, z=12)
  saveRDS(map_raster1,here::here('Mapas/Raster_TAMAULIPAS/map_raster1.RDS'))
}

levelplot(map_raster1, par.settings= viridisTheme()) + 
  layer(panel.points(COORD_SIM_D01$LON ,
                     COORD_SIM_D01$LAT, pch=21, cex=1, colour='white', fill= 'white'))+
  layer(panel.points(LON_TNK ,
                     LAT_TNK, pch=21, cex=1, colour='white', fill= 'red'))


```

```{r fig.width=10, fig.height=10, echo=FALSE, message=FALSE, results='hide'}
n=max(LAT_TNK) 
s=min(LAT_TNK)    
e=max(LON_TNK)    
w=min(LON_TNK) 

incr<- 0.1


if(n > 0){n<- n + incr}else{n<- n + incr}
if(s > 0){s<- s - incr}else{s<- s- incr}
if(e > 0){e<- e + incr}else{e<- e + incr}
if(w > 0){w<- w - incr}else{w<- w- incr}



ul <- round(c(n,w),digits = 2)  #Upper Left
lr <- round(c(s,e), digits = 2)  #Lower Right


lon_location<- seq(lr[1],ul[1],length.out = 100 ) 
lat_location<- seq(ul[2],lr[2], length.out = 100)
data_loc<- expand.grid(lat_location,lon_location)
colnames(data_loc)<- c("x", "y")

spdf <- SpatialPointsDataFrame(coords = data_loc, data = data_loc,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

if(!dir.exists(here::here('Mapas/Raster_TATANKA/'))){dir.create(here::here('Mapas/Raster_TATANKA/'), recursive = T)}

if(file.exists(here::here('Mapas/Raster_TATANKA/map_raster1.RDS'))){
  map_raster1<- readRDS(here::here('Mapas/Raster_TATANKA/map_raster2.RDS'))
}else{
  map_raster1<- get_elev_raster(spdf, z=12)
  saveRDS(map_raster1,here::here('Mapas/Raster_TATANKA/map_raster2.RDS'))
}

levelplot(map_raster1, par.settings= viridisTheme()) + 
  layer(panel.points(COORD_SIM_D01$LON ,
                     COORD_SIM_D01$LAT, pch=21, cex=2, colour='white', fill= 'white'))+
layer(panel.points(COORD_SIM_D02$LON ,
                   COORD_SIM_D02$LAT, pch=21, cex=1.5, colour='white', fill= 'green'))+
  layer(panel.points(COORD_SIM_D03$LON ,
                     COORD_SIM_D03$LAT, pch=21, cex=1, colour='white', fill= 'orange'))+
  layer(panel.points(LON_TNK ,
                     LAT_TNK, pch=21, cex=1, colour='white', fill= 'red'))


```

```{r eval= FALSE}

CSV_FILES<- list.files(PATH_TO_CSVS, recursive = T, full.names = T) %>% .[str_detect(., '.csv')]
DOMINIOS<- c('D01', 'D02', 'D03')
LISTA_CORR_LEVEL<- list()
LISTA_DATOS_LEVELS<- list()
for(LEVELS in 1:10){
  LISTA_DATOS<- list()
  LISTA_CORR_DOM<- list()
  for(DOM in 1:3){
    
    CSV_FILES_D01<- CSV_FILES %>% .[str_detect(.,DOMINIOS[DOM])]
    
    
    #CREAMOS LA LISTA COMPLETA
    LISTA_SIM<- list()
    for( i in 1:length(CSV_FILES_D01)){
      LISTA_SIM[[i]]<-CSV_FILES_D01[i] %>% read.csv(header = T)
    }
    
    
    TABLA_SIM<- bind_rows(LISTA_SIM)
    TABLA_SIM_0<- TABLA_SIM %>% group_split(LEVEL) %>% .[[LEVELS]]
    for(i in 1:nrow(TABLA_SIM_0)){
      TABLA_SIM_0[i, 'DIST']<- distm(TABLA_SIM_0[i, c("LON", "LAT")], c(LON_TNK, LAT_TNK))
    }
    
    
    
    DISTANCIAS_MENORES<- TABLA_SIM_0$DIST %>% unique() %>% .[order(., decreasing = FALSE)] %>% .[1:50]
    TABLA_SIM_10<- TABLA_SIM_0[TABLA_SIM_0$DIST%in%DISTANCIAS_MENORES, ]
    
    
    TABLA_CORR<- data.frame(matrix(ncol = 8))
    for(i in 1:length( TABLA_SIM_10 %>% group_split(LON,LAT))){
      
      TABLA_INDV<- TABLA_SIM_10 %>% group_split(LON,LAT)%>% .[[i]]
      TABLA_INDV$DATE<-ymd_hms(TABLA_INDV$DATE)
      TABLA_1<- TABLA_INDV[duplicated(TABLA_INDV$DATE),] %>% .[complete.cases(.),]
      TABLA_2<- TABLA_INDV[!duplicated(TABLA_INDV$DATE),] %>% .[complete.cases(.),]
      
      
      INFO_PARQUES<- readRDS(here::here('Data/Parques/PRUEBA_EOLICOS/Historico_PE.RDS'))
      INFO_TATANKA<- INFO_PARQUES[str_detect(INFO_PARQUES$PARQUE, 'Tamaulipas'),]
      TABLA_1_JOIN<- left_join(TABLA_1, INFO_TATANKA , by= 'DATE') %>% .[complete.cases(.),]
      TABLA_2_JOIN<- left_join(TABLA_2, INFO_TATANKA , by= 'DATE') %>% .[complete.cases(.),]
      
      
      
      
      
      TABLA_2_JOIN$PRUDUCCION_DISP_NORM<- (TABLA_2_JOIN$PRUDUCCION_MWH*TABLA_2_JOIN$DISPONIBILIDAD/100 - mean(TABLA_2_JOIN$PRUDUCCION_MWH*TABLA_2_JOIN$DISPONIBILIDAD/100))/sd(TABLA_2_JOIN$PRUDUCCION_MWH*TABLA_2_JOIN$DISPONIBILIDAD/100)
      TABLA_2_JOIN$PRUDUCCION_MWH_NORM<- (TABLA_2_JOIN$PRUDUCCION_MWH - mean(TABLA_2_JOIN$PRUDUCCION_MWH))/sd(TABLA_2_JOIN$PRUDUCCION_MWH)
      
      TABLA_2_JOIN$WS_NORM<- (TABLA_2_JOIN$WS - mean(TABLA_2_JOIN$WS))/sd(TABLA_2_JOIN$WS)
      TABLA_2_JOIN$WS3_NORM<- (TABLA_2_JOIN$WS^3 - mean(TABLA_2_JOIN$WS^3))/sd(TABLA_2_JOIN$WS^3)
      
      
      TABLA_1_JOIN$PRUDUCCION_DISP_NORM<- (TABLA_1_JOIN$PRUDUCCION_MWH*TABLA_1_JOIN$DISPONIBILIDAD/100 - mean(TABLA_1_JOIN$PRUDUCCION_MWH*TABLA_1_JOIN$DISPONIBILIDAD/100))/sd(TABLA_1_JOIN$PRUDUCCION_MWH*TABLA_1_JOIN$DISPONIBILIDAD/100)
      TABLA_1_JOIN$PRUDUCCION_MWH_NORM<- (TABLA_1_JOIN$PRUDUCCION_MWH - mean(TABLA_1_JOIN$PRUDUCCION_MWH))/sd(TABLA_1_JOIN$PRUDUCCION_MWH)
      
      TABLA_1_JOIN$WS_NORM<- (TABLA_1_JOIN$WS - mean(TABLA_1_JOIN$WS))/sd(TABLA_1_JOIN$WS)
      TABLA_1_JOIN$WS3_NORM<- (TABLA_1_JOIN$WS^3 - mean(TABLA_1_JOIN$WS^3))/sd(TABLA_1_JOIN$WS^3)
      
      
      
      
      CORR_WS_1<- cor(TABLA_1_JOIN$WS_NORM, TABLA_1_JOIN$PRUDUCCION_DISP_NORM, use = 'complete.obs')
      CORR_WS3_1<- cor(TABLA_1_JOIN$WS3_NORM, TABLA_1_JOIN$PRUDUCCION_DISP_NORM)
      
      CORR_WS_2<- cor(TABLA_2_JOIN$WS_NORM, TABLA_2_JOIN$PRUDUCCION_DISP_NORM)
      CORR_WS3_2<- cor(TABLA_2_JOIN$WS3_NORM, TABLA_2_JOIN$PRUDUCCION_DISP_NORM)
      
      CORR_WS_WO_NORM_1<- cor(TABLA_1_JOIN$WS, TABLA_1_JOIN$PRUDUCCION_MWH)
      CORR_WS_WO_NORM_2<- cor(TABLA_2_JOIN$WS, TABLA_2_JOIN$PRUDUCCION_MWH)
      
      CORR_WS3_WO_NORM_1<- cor(TABLA_1_JOIN$WS^3, TABLA_1_JOIN$PRUDUCCION_MWH)
      CORR_WS3_WO_NORM_2<- cor(TABLA_2_JOIN$WS^3, TABLA_2_JOIN$PRUDUCCION_MWH)
      
      TABLA_CORR[i,]<- c(CORR_WS_1, CORR_WS3_1, CORR_WS_WO_NORM_1,CORR_WS3_WO_NORM_1, 
                         CORR_WS_2, CORR_WS3_2, CORR_WS_WO_NORM_2,CORR_WS3_WO_NORM_2)
      
      
    }
    
    print(ggplot()+
            geom_line(data = TABLA_1_JOIN, aes(x= DATE, y= PRUDUCCION_MWH_NORM))+
            geom_line(data = TABLA_1_JOIN, aes(x= DATE, y= WS_NORM), col='red')+
            geom_line(data = TABLA_1_JOIN, aes(x= DATE, y= WS3_NORM), col='orange')+
            theme_light())
    
    LISTA_CORR_DOM[[DOM]]<- TABLA_CORR
    
  }
  
  LISTA_CORR_LEVEL[[LEVELS]]<- LISTA_CORR_DOM
  LISTA_DATOS_LEVELS[[LEVELS]]<- LISTA_DATOS
  
}




TABLA_DOM<- LISTA_DATOS[[1]]

for(i in 1:length( TABLA_DOM %>% group_split(LON,LAT))){
  
  TABLA_INDV<- TABLA_DOM %>% group_split(LON,LAT)%>% .[[i]]
  TABLA_INDV$DATE<-ymd_hms(TABLA_INDV$DATE)
  TABLA_1<- TABLA_INDV[duplicated(TABLA_INDV$DATE),] %>% .[complete.cases(.),]
  TABLA_2<- TABLA_INDV[!duplicated(TABLA_INDV$DATE),] %>% .[complete.cases(.),]
  
  
  INFO_PARQUES<- readRDS(here::here('Data/Parques/PRUEBA_EOLICOS/Historico_PE.RDS'))
  INFO_TATANKA<- INFO_PARQUES[str_detect(INFO_PARQUES$PARQUE, 'Tamaulipas'),]
  TABLA_1_JOIN<- left_join(TABLA_1, INFO_TATANKA , by= 'DATE') %>% .[complete.cases(.),]
  TABLA_2_JOIN<- left_join(TABLA_2, INFO_TATANKA , by= 'DATE') %>% .[complete.cases(.),]
  
  
  
  
  
  TABLA_2_JOIN$PRUDUCCION_DISP_NORM<- (TABLA_2_JOIN$PRUDUCCION_MWH*TABLA_2_JOIN$DISPONIBILIDAD/100 - mean(TABLA_2_JOIN$PRUDUCCION_MWH*TABLA_2_JOIN$DISPONIBILIDAD/100))/sd(TABLA_2_JOIN$PRUDUCCION_MWH*TABLA_2_JOIN$DISPONIBILIDAD/100)
  TABLA_2_JOIN$PRUDUCCION_MWH_NORM<- (TABLA_2_JOIN$PRUDUCCION_MWH - mean(TABLA_2_JOIN$PRUDUCCION_MWH))/sd(TABLA_2_JOIN$PRUDUCCION_MWH)
  
  TABLA_2_JOIN$WS_NORM<- (TABLA_2_JOIN$WS - mean(TABLA_2_JOIN$WS))/sd(TABLA_2_JOIN$WS)
  TABLA_2_JOIN$WS3_NORM<- (TABLA_2_JOIN$WS^3 - mean(TABLA_2_JOIN$WS^3))/sd(TABLA_2_JOIN$WS^3)
  
  ggplot()+
    geom_line(data = TABLA_1_JOIN, aes(x= DATE, y= PRUDUCCION_MWH))+
    geom_line(data = TABLA_1_JOIN, aes(x= DATE, y= WS), col='red')+
    geom_line(data = TABLA_1_JOIN, aes(x= DATE, y= 0.5*1.2*12272*61*WS^3/10^6*0.3), col='orange')+
    theme_light()
  
  
  
  
  
  
  TABLA_1_JOIN$PRUDUCCION_DISP_NORM<- (TABLA_1_JOIN$PRUDUCCION_MWH*TABLA_1_JOIN$DISPONIBILIDAD/100 - mean(TABLA_1_JOIN$PRUDUCCION_MWH*TABLA_1_JOIN$DISPONIBILIDAD/100))/sd(TABLA_1_JOIN$PRUDUCCION_MWH*TABLA_1_JOIN$DISPONIBILIDAD/100)
  TABLA_1_JOIN$PRUDUCCION_MWH_NORM<- (TABLA_1_JOIN$PRUDUCCION_MWH - mean(TABLA_1_JOIN$PRUDUCCION_MWH))/sd(TABLA_1_JOIN$PRUDUCCION_MWH)
  
  TABLA_1_JOIN$WS_NORM<- (TABLA_1_JOIN$WS - mean(TABLA_1_JOIN$WS))/sd(TABLA_1_JOIN$WS)
  TABLA_1_JOIN$WS3_NORM<- (TABLA_1_JOIN$WS^3 - mean(TABLA_1_JOIN$WS^3))/sd(TABLA_1_JOIN$WS^3)
  
  
  
  
  CORR_WS_1<- cor(TABLA_1_JOIN$WS_NORM, TABLA_1_JOIN$PRUDUCCION_DISP_NORM, use = 'complete.obs')
  CORR_WS3_1<- cor(TABLA_1_JOIN$WS3_NORM, TABLA_1_JOIN$PRUDUCCION_DISP_NORM)
  
  CORR_WS_2<- cor(TABLA_2_JOIN$WS_NORM, TABLA_2_JOIN$PRUDUCCION_DISP_NORM)
  CORR_WS3_2<- cor(TABLA_2_JOIN$WS3_NORM, TABLA_2_JOIN$PRUDUCCION_DISP_NORM)
  
  CORR_WS_WO_NORM_1<- cor(TABLA_1_JOIN$WS, TABLA_1_JOIN$PRUDUCCION_MWH)
  CORR_WS_WO_NORM_2<- cor(TABLA_2_JOIN$WS, TABLA_2_JOIN$PRUDUCCION_MWH)
  
  CORR_WS3_WO_NORM_1<- cor(TABLA_1_JOIN$WS^3, TABLA_1_JOIN$PRUDUCCION_MWH)
  CORR_WS3_WO_NORM_2<- cor(TABLA_2_JOIN$WS^3, TABLA_2_JOIN$PRUDUCCION_MWH)
  
  TABLA_CORR[i,]<- c(CORR_WS_1, CORR_WS3_1, CORR_WS_WO_NORM_1,CORR_WS3_WO_NORM_1, 
                     CORR_WS_2, CORR_WS3_2, CORR_WS_WO_NORM_2,CORR_WS3_WO_NORM_2)
}



TABLA_CORRS<- LISTA_CORR_LEVEL %>% sapply(function(x){lapply(x, function(y){print(max(y))})})

colnames(TABLA_CORRS)<-paste0('L' , seq(1,10,1))
rownames(TABLA_CORRS)<- c('D01', 'D02', 'D03')

dir.create(here::here('Data/Parques/PRUEBA_EOLICOS/TAMAULIPAS_DATA/'))
saveRDS(LISTA_DATOS_LEVELS,here::here('Data/Parques/PRUEBA_EOLICOS/TAMAULIPAS_DATA/LISTA_DATOS.RDS'))
saveRDS(LISTA_CORR_LEVEL,here::here('Data/Parques/PRUEBA_EOLICOS/TAMAULIPAS_DATA/LISTA_CORRELATION.RDS'))

```

```{r}
LISTA_DATOS_LEVELS<- readRDS(here::here('Data/Parques/PRUEBA_EOLICOS/TAMAULIPAS_DATA/LISTA_DATOS.RDS'))
LISTA_CORR_LEVEL <- readRDS(here::here('Data/Parques/PRUEBA_EOLICOS/TAMAULIPAS_DATA/LISTA_CORRELATION.RDS'))

```

```{r}

LISTA_2<- LISTA_CORR_LEVEL %>% lapply(function(x){
  TABLA<- x %>% sapply(function(y){
    colMeans(y)
  })
  colnames(TABLA)<- c('D01', 'D02', 'D03')
  rownames(TABLA)<- c('WS_NORMALIZADO', 'WS3_NORMALIZADO', 'WS_SIN_NORMALIZAR', 'WS3_SIN_NORMALIZAR',
                      '2WS_NORMALIZADO', '2WS3_NORMALIZADO', '2WS_SIN_NORMALIZAR', '2WS3_SIN_NORMALIZAR')
  return(TABLA)
  })

MATRIZ_SUMA<- data.frame(matrix(0,ncol = 3, nrow = 8))
for (i in 1:10) {
  MATRIZ_SUMA= MATRIZ_SUMA + LISTA_2[[i]]
}
MATRIZ_SUMA<- MATRIZ_SUMA/10
rownames(MATRIZ_SUMA)<- rownames(LISTA_2[[1]])
colnames(MATRIZ_SUMA)<- colnames(LISTA_2[[1]])
MATRIZ_SUMA


```

